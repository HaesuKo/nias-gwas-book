---
title: "Pre-GWAS ì ˆì°¨: ìœ ì „ìí˜• ë°ì´í„° QC"
author:
  - name: "ê³ í•´ìˆ˜, ë†í•™ë°•ì‚¬"
    affiliation: "êµ­ë¦½ì¶•ì‚°ê³¼í•™ì›(NIAS) ê°€ì¶•ê°œëŸ‰í‰ê°€ê³¼"
    email: "kosoo91@korea.kr"
date: "`r format(Sys.Date())`"

output:
  rmdformats::readthedown:
    toc_depth: 3
    highlight: kate
    includes:
      in_header:
        - copy-button.html
    css: custom.css
resource_files:
  - copy-button.html

lang: ko
encoding: UTF-8

params:
  base_dir: "02_reports"
  breeds: ["holstein", "jersey"]
  mind_thr: 0.05
  geno_thr: 0.05
  hwe_thr: 1.0e-6
  maf_thr: 0.05
---
# Pre-GWAS ì ˆì°¨: ìœ ì „ìí˜• ë°ì´í„° QC

ê°œìš”
<div class="alert alert-info checklist" role="alert">
  <p><span class="icon">ğŸ“‹</span> <strong>GWAS ë¶„ì„ì„ ìœ„í•œ ìœ ì „ìí˜• ë°ì´í„° QC ì›Œí¬í”Œë¡œìš°</strong> (Windows RStudio + PLINK2 + awk)</p>
  <ul class="tight">
    <li>ìœ ì „ìí˜• ë°ì´í„° ë³€í™˜ (PED/MAP â†’ PGEN)</li>
    <li>REF/ALT allele ì˜¤ë¥˜ ë³€ì´ ì œê±°</li>
    <li>1ì°¨ í•„í„° ì ìš© (autosomes + X, biallelic, monomorphic ì œê±°, ì¤‘ë³µ ì œê±°)</li>
    <li>í’ˆì¢…ë³„ IID ëª©ë¡ ì¤€ë¹„ ë° ë°ì´í„°ì…‹ ë¶„ë¦¬</li>
    <li>í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ ìƒì„± (missingness, HWE, allele frequency)</li>
    <li>RStudioì—ì„œ í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ í™•ì¸ ë° 2ì°¨ í•„í„° ê°’ ê²°ì •</li>
    <li>í’ˆì¢…ë³„ 2ì°¨ í•„í„° ì ìš© ë° ìµœì¢… ìœ ì „ìí˜• ì„¸íŠ¸ ìƒì„± (PLINK1 binary)</li>
  </ul>
</div>

---

## [RStudio Terminal] ì „ì²´ ìœ ì „ìí˜• ë°ì´í„° QC ì›Œí¬í”Œë¡œìš°

ì•„ë˜ ë‹¨ê³„ë“¤ì€ ëª¨ë‘ **R ì½˜ì†”ì´ ì•„ë‹ˆë¼ RStudioì˜ Terminal íƒ­**ì—ì„œ ì‹¤í–‰í•œë‹¤.

- RStudio í™”ë©´ í•˜ë‹¨ì˜ **Console** ì˜† **Terminal** íƒ­ì„ í´ë¦­
- Windowsì—ì„œëŠ” `cmd.exe` ë˜ëŠ” `PowerShell`ì´ ìë™ ì‹¤í–‰ë˜ë©°, Mac/Linuxì—ì„œëŠ” `bash/zsh` ì…¸ì´ ì—´ë¦¼
- ê° ë‹¨ê³„ì˜ ì½”ë“œ ë¸”ë¡ ìš°ì¸¡ ìƒë‹¨ì˜ ğŸ“‹ë³µì‚¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë³µì‚¬í•œ ë’¤, **Terminal** íƒ­ì˜ `>` ì˜†ì— ë§ˆìš°ìŠ¤ ì˜¤ë¥¸ìª½ ë²„íŠ¼ì„ í´ë¦­ í•œ í›„ <kbd style="background:#e5e7eb; color:#111; border-radius:4px; padding:2px 6px;">Paste</kbd>ë¥¼ í´ë¦­í•˜ê³  <kbd>Enter</kbd>ë¥¼ ëˆ„ë¥´ë©´ ì‹¤í–‰
- ì‹¤í–‰ ê²°ê³¼ë¬¼ì€ ê° ë‹¨ê³„ì˜ **â€œìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼â€** ì„¤ëª…ì— ë”°ë¼ í™•ì¸

---

### 0) ê²°ê³¼ ì €ì¥ ë””ë ‰í„°ë¦¬ ì¤€ë¹„
ì‘ì—… ì „ ë‹¨ê³„ë³„ ê²°ê³¼ë¥¼ ì €ì¥í•  ë””ë ‰í† ë¦¬ ìƒì„±

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ’»</span> <strong>0) ì¶œë ¥ í´ë” ìƒì„± (ì „ì²´ ë°ì´í„°ì…‹)</strong></p>
  <pre><code class="language-bash">mkdir 00_import 01_autosomesX 02_reports 03_qc 04_split</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” í´ë”:</em><br>
  <code>00_import/</code>, <code>01_autosomesX/</code>, <code>02_reports/</code>, <code>03_qc/</code>, <code>04_split/</code></p>
</div>

---

### 1) ì›ë³¸ PED/MAPì„ PLINK2 PGEN ì„¸íŠ¸ë¡œ ë³€í™˜
PLINK1 í˜•ì‹(PED/MAP)ì„ PLINK2 í˜•ì‹(PGEN/PVAR/PSAM)ìœ¼ë¡œ ë³€í™˜

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ’»</span> <strong>1) PED/MAP â†’ PGEN ë³€í™˜ (ì „ì²´ ë°ì´í„°ì…‹)</strong></p>
  <pre><code class="language-bash">plink2 --cow --pedmap NIAS_ibv3_296ea --sort-vars --make-pgen --out 00_import/NIAS_ibv3_296ea</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>00_import/NIAS_ibv3_296ea.[pgen|pvar|psam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --cow
  --make-pgen
  --out 00_import\NIAS_ibv3_296ea
  --pedmap NIAS_ibv3_296ea
  --sort-vars

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:23 2025

Random number seed: 1755676403
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
--pedmap: 53218 variants in .map file.
--pedmap: 296 samples present, genotypes extracted to
00_import\NIAS_ibv3_296ea-temporary.bed.smaj .
Transposing sample-major .bed to 00_import\NIAS_ibv3_296ea-temporary.pgen , and
setting major alleles to provisional-REF.
Transpose complete.
--pedmap: 00_import\NIAS_ibv3_296ea-temporary.pgen +
00_import\NIAS_ibv3_296ea-temporary.pvar +
00_import\NIAS_ibv3_296ea-temporary.psam written. .bed.smaj and .fam.tmp
temporary files deleted.
296 samples (0 females, 0 males, 296 ambiguous; 296 founders) loaded from
00_import\NIAS_ibv3_296ea-temporary.psam.
53218 variants loaded from 00_import\NIAS_ibv3_296ea-temporary.pvar.
Note: No phenotype data present.
Writing 00_import\NIAS_ibv3_296ea.pvar ... done.
Writing 00_import\NIAS_ibv3_296ea.psam ... done.
Writing 00_import\NIAS_ibv3_296ea.pgen ... done.

End time: Wed Aug 20 16:53:24 2025
    </code></pre>
  </details>
---

### 2) REF/ALT `.` ì˜¤ë¥˜ ë³€ì´ ì œê±°
REF ë° ALT alleleì´ `.`ìœ¼ë¡œ ì§€ì •ëœ ë³€ì´ë¥¼ ì œê±°í•œ ë°ì´í„°ì…‹ ìƒì„±

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ’»</span> <strong>2-1) REF/ALTê°€ ëª¨ë‘ â€˜.â€™ ì¸ ë³€ì´ ì „ì²´ í–‰ ì¶”ì¶œ (awk)</strong></p>
  <pre><code class="language-bash">awk -F '\t' "NR&gt;1 &amp;&amp; $4==\".\" &amp;&amp; $5==\".\"" 00_import/NIAS_ibv3_296ea.pvar &gt; bad_refalt_ids_both_strict.txt</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>bad_refalt_ids_both_strict.txt</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ bad_refalt_ids_both_strict.txt â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
0   0   BTA-91057-no-rs   .   .   0
2   104844698   ARS-BFGL-NGS-40237   .   .   117.9899
3   47820211    BTB-00462798         .   .   70.45705
3   86433347    ARS-BFGL-NGS-11769   .   .   109.0945
3   120031577   BTB-01714430         .   .   126.98
6   108805685   Hapmap39313-BTA-121776  .   .   112.8388
13  21528917    ARS-BFGL-NGS-59624   .   .   1.695824
15  49076839    ARS-BFGL-BAC-20572   .   .   47.92302
15  57434389    ARS-BFGL-BAC-19997   .   .   54.28989
19  27444684    ARS-BFGL-NGS-38067   .   .   48.69351
23  39274007    BovineHD2300011347   .   .   0
X   98185142    ARS-BFGL-NGS-2544    .   .   99.77262
Y   0           BovineHD3100000048   .   .   0
Y   0           BovineHD3100000210   .   .   0
Y   0           BovineHD3100000515   .   .   0
Y   0           BovineHD3100000517   .   .   0
Y   0           BovineHD3100001404   .   .   0
  </code></pre>
</details>

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ’»</span> <strong>2-2) ë¬¸ì œ ë³€ì´ì˜ IDë§Œ ì¶”ì¶œ (awk)</strong></p>
  <pre><code class="language-bash">awk -F '\t' "NR&gt;1 &amp;&amp; $4==\".\" &amp;&amp; $5==\".\" {print $3}" 00_import/NIAS_ibv3_296ea.pvar &gt; bad_refalt_ids.txt</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>bad_refalt_ids.txt</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ bad_refalt_ids.txt â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
BTA-91057-no-rs
ARS-BFGL-NGS-40237
BTB-00462798
ARS-BFGL-NGS-11769
BTB-01714430
Hapmap39313-BTA-121776
ARS-BFGL-NGS-59624
ARS-BFGL-BAC-20572
ARS-BFGL-BAC-19997
ARS-BFGL-NGS-38067
BovineHD2300011347
ARS-BFGL-NGS-2544
BovineHD3100000048
BovineHD3100000210
BovineHD3100000515
BovineHD3100000517
BovineHD3100001404
  </code></pre>
</details>
<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ’»</span> <strong>2-3) ë¬¸ì œ ë³€ì´ë¥¼ ì œì™¸í•œ pfile ìƒì„± (ì „ì²´ ë°ì´í„°ì…‹)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 00_import/NIAS_ibv3_296ea --exclude bad_refalt_ids.txt --make-pgen --out 00_import/NIAS_ibv3_296ea.clean</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>00_import/NIAS_ibv3_296ea.clean.[pgen|pvar|psam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --exclude bad_refalt_ids.txt
  --make-pgen
  --out 00_import/NIAS_ibv3_296ea.clean
  --pfile 00_import/NIAS_ibv3_296ea

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:24 2025

Random number seed: 1755676404
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
296 samples (0 females, 0 males, 296 ambiguous; 296 founders) loaded from
00_import/NIAS_ibv3_296ea.psam.
chrSet header line: 29 autosome pairs.
53218 variants loaded from 00_import/NIAS_ibv3_296ea.pvar.
Note: No phenotype data present.
--exclude: 53201 variants remaining.
53201 variants remaining after main filters.
Writing 00_import/NIAS_ibv3_296ea.clean.psam ... done.
Writing 00_import/NIAS_ibv3_296ea.clean.pvar ... done.
Writing 00_import/NIAS_ibv3_296ea.clean.pgen ... done.

End time: Wed Aug 20 16:53:25 2025
  </code></pre>
</details>
---

### 3) 1ì°¨ í•„í„° ì ìš©
Autosomes + X ì—¼ìƒ‰ì²´ë§Œ ë‚¨ê¸°ê³ , ë‹¤ëŒ€ë¦½ì„±/ë‹¨ì¼í˜•/ì¤‘ë³µ ë³€ì´ ì œê±°

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ’»</span> <strong>3) Autosomes + X, biallelic only, no monomorphic or duplicate variants (ì „ì²´ ë°ì´í„°ì…‹)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 00_import/NIAS_ibv3_296ea.clean --chr 1-29,X --max-alleles 2 --mac 1 --rm-dup force-first --sort-vars --make-pgen --out 01_autosomesX/NIAS_ibv3_296ea.autosomesX</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>01_autosomesX/NIAS_ibv3_296ea.autosomesX.[pgen|pvar|psam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --chr 1-29,X
  --mac 1
  --make-pgen
  --max-alleles 2
  --out 01_autosomesX/NIAS_ibv3_296ea.autosomesX
  --pfile 00_import/NIAS_ibv3_296ea.clean
  --rm-dup force-first
  --sort-vars

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:25 2025

Random number seed: 1755676405
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
296 samples (0 females, 0 males, 296 ambiguous; 296 founders) loaded from
00_import/NIAS_ibv3_296ea.clean.psam.
chrSet header line: 29 autosome pairs.
52424 out of 53201 variants loaded from 00_import/NIAS_ibv3_296ea.clean.pvar.
Note: No phenotype data present.
Note: Skipping --rm-dup since no duplicate IDs are present.
Calculating allele frequencies... done.
4848 variants removed due to allele frequency threshold(s)
(--maf/--max-maf/--mac/--max-mac).
47576 variants remaining after main filters.
Writing 01_autosomesX/NIAS_ibv3_296ea.autosomesX.pvar ... done.
Writing 01_autosomesX/NIAS_ibv3_296ea.autosomesX.psam ... done.
Writing 01_autosomesX/NIAS_ibv3_296ea.autosomesX.pgen ... done.

End time: Wed Aug 20 16:53:25 2025
  </code></pre>
</details>
---

### 4) í’ˆì¢…ë³„ IID ëª©ë¡ ì¤€ë¹„
Holstein / Jersey ê°œì²´ ID íŒŒì¼ì„ FID IID ëª©ë¡ìœ¼ë¡œ ë§¤ì¹­(PSAM ê¸°ë°˜)

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ„</span> <strong>4-1) Holstein (í™€ìŠ¤íƒ€ì¸) IID ë³€í™˜</strong></p>
  <pre><code class="language-bash">awk "NR==FNR {iid[$1]=1; next} FNR&gt;1 &amp;&amp; ($2 in iid) {print $1, $2}" holstein.txt 01_autosomesX/NIAS_ibv3_296ea.autosomesX.psam &gt; holstein_ids.txt</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>holstein_ids.txt</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ holstein_ids.txt â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
1 3530
2 3528
3 3527
4 3195
5 3994
...
195 4354
196 4353
197 4352
198 4163
199 4351
200 4279
  </code></pre>
</details>
<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ‚</span> <strong>4-2) Jersey (ì €ì§€) IID ë³€í™˜</strong></p>
  <pre><code class="language-bash">awk "NR==FNR {iid[$1]=1; next} FNR&gt;1 &amp;&amp; ($2 in iid) {print $1, $2}" jersey.txt 01_autosomesX/NIAS_ibv3_296ea.autosomesX.psam &gt; jersey_ids.txt</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>jersey_ids.txt</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ jersey_ids.txt â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
201 4273
202 4284
203 4289
204 4230
205 4292
...
292 4318
293 4317
294 4096
295 4179
296 4316
  </code></pre>
</details>
---

### 5) í’ˆì¢…ë³„ ì„œë¸Œì…‹ pfile ìƒì„±
í’ˆì¢…ë³„ IID ëª©ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ì…‹ ë¶„ë¦¬

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ„</span> <strong>5-1) Holstein (í™€ìŠ¤íƒ€ì¸) ì„œë¸Œì…‹</strong></p>
  <pre><code class="language-bash">plink2 --pfile 01_autosomesX/NIAS_ibv3_296ea.autosomesX --keep holstein_ids.txt --make-pgen --out 04_split/NIAS_ibv3_296ea.holstein</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>04_split/NIAS_ibv3_296ea.holstein.[pgen|pvar|psam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --keep holstein_ids.txt
  --make-pgen
  --out 04_split/NIAS_ibv3_296ea.holstein
  --pfile 01_autosomesX/NIAS_ibv3_296ea.autosomesX

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:26 2025

Random number seed: 1755676406
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
296 samples (0 females, 0 males, 296 ambiguous; 296 founders) loaded from
01_autosomesX/NIAS_ibv3_296ea.autosomesX.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 01_autosomesX/NIAS_ibv3_296ea.autosomesX.pvar.
Note: No phenotype data present.
--keep: 200 samples remaining.
200 samples (0 females, 0 males, 200 ambiguous; 200 founders) remaining after
main filters.
Writing 04_split/NIAS_ibv3_296ea.holstein.psam ... done.
Writing 04_split/NIAS_ibv3_296ea.holstein.pvar ... done.
Writing 04_split/NIAS_ibv3_296ea.holstein.pgen ... done.

End time: Wed Aug 20 16:53:26 2025
  </code></pre>
</details>
<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ‚</span> <strong>5-2) Jersey (ì €ì§€) ì„œë¸Œì…‹</strong></p>
  <pre><code class="language-bash">plink2 --pfile 01_autosomesX/NIAS_ibv3_296ea.autosomesX --keep jersey_ids.txt --make-pgen --out 04_split/NIAS_ibv3_296ea.jersey</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>04_split/NIAS_ibv3_296ea.jersey.[pgen|pvar|psam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --keep jersey_ids.txt
  --make-pgen
  --out 04_split/NIAS_ibv3_296ea.jersey
  --pfile 01_autosomesX/NIAS_ibv3_296ea.autosomesX

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:26 2025

Random number seed: 1755676406
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
296 samples (0 females, 0 males, 296 ambiguous; 296 founders) loaded from
01_autosomesX/NIAS_ibv3_296ea.autosomesX.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 01_autosomesX/NIAS_ibv3_296ea.autosomesX.pvar.
Note: No phenotype data present.
--keep: 96 samples remaining.
96 samples (0 females, 0 males, 96 ambiguous; 96 founders) remaining after main
filters.
Writing 04_split/NIAS_ibv3_296ea.jersey.psam ... done.
Writing 04_split/NIAS_ibv3_296ea.jersey.pvar ... done.
Writing 04_split/NIAS_ibv3_296ea.jersey.pgen ... done.

End time: Wed Aug 20 16:53:26 2025
  </code></pre>
</details>
---

### 6) 2ì°¨ í•„í„° ì ìš© ë° ìµœì¢… ë°ì´í„°ì…‹ ìƒì„±
í†µìš©ë˜ëŠ” QC ê¸°ì¤€ê°’ì„ ì ìš©í•˜ì—¬ ìµœì¢… PLINK1 binary íŒŒì¼ ìƒì„± 

- mind = 0.05, geno = 0.05, hwe = 1e-6, maf = 0.05 

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ„</span> <strong>6-1) Holstein (í™€ìŠ¤íƒ€ì¸)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 04_split/NIAS_ibv3_296ea.holstein --mind 0.05 --geno 0.05 --maf 0.05 --hwe 1e-6 --make-bed --out 03_qc/NIAS_ibv3_296ea.holstein</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>03_qc/NIAS_ibv3_296ea.holstein.[bed|bim|fam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --geno 0.05
  --hwe 1e-6
  --maf 0.05
  --make-bed
  --mind 0.05
  --out 03_qc/NIAS_ibv3_296ea.holstein
  --pfile 04_split/NIAS_ibv3_296ea.holstein

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Mon Aug 25 19:11:34 2025

Random number seed: 1756116694
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
200 samples (0 females, 0 males, 200 ambiguous; 200 founders) loaded from
04_split/NIAS_ibv3_296ea.holstein.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 04_split/NIAS_ibv3_296ea.holstein.pvar.
Note: No phenotype data present.
Calculating sample missingness rates... done.
0 samples removed due to missing genotype data (--mind).
200 samples (0 females, 0 males, 200 ambiguous; 200 founders) remaining after
main filters.
Calculating allele frequencies... done.
--geno: 193 variants removed due to missing genotype data.
--hwe: 37 variants removed due to Hardy-Weinberg exact test (founders only).
5732 variants removed due to allele frequency threshold(s)
(--maf/--max-maf/--mac/--max-mac).
41614 variants remaining after main filters.
Writing 03_qc/NIAS_ibv3_296ea.holstein.fam ... done.
Writing 03_qc/NIAS_ibv3_296ea.holstein.bim ... done.
Writing 03_qc/NIAS_ibv3_296ea.holstein.bed ... done.

End time: Mon Aug 25 19:11:34 2025
  </code></pre>
</details>
<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ‚</span> <strong>6-2) Jersey (ì €ì§€)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 04_split/NIAS_ibv3_296ea.jersey --mind 0.05 --geno 0.05 --maf 0.05 --hwe 1e-6 --make-bed --out 03_qc/NIAS_ibv3_296ea.jersey</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>03_qc/NIAS_ibv3_296ea.jersey.[bed|bim|fam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --geno 0.05
  --hwe 1e-6
  --maf 0.05
  --make-bed
  --mind 0.05
  --out 03_qc/NIAS_ibv3_296ea.jersey
  --pfile 04_split/NIAS_ibv3_296ea.jersey

Hostname: RDA
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Mon Aug 25 19:11:40 2025

Random number seed: 1756116700
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
96 samples (0 females, 0 males, 96 ambiguous; 96 founders) loaded from
04_split/NIAS_ibv3_296ea.jersey.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 04_split/NIAS_ibv3_296ea.jersey.pvar.
Note: No phenotype data present.
Calculating sample missingness rates... done.
0 samples removed due to missing genotype data (--mind).
96 samples (0 females, 0 males, 96 ambiguous; 96 founders) remaining after main
filters.
Calculating allele frequencies... done.
--geno: 154 variants removed due to missing genotype data.
--hwe: 18 variants removed due to Hardy-Weinberg exact test (founders only).
12329 variants removed due to allele frequency threshold(s)
(--maf/--max-maf/--mac/--max-mac).
35075 variants remaining after main filters.
Writing 03_qc/NIAS_ibv3_296ea.jersey.fam ... done.
Writing 03_qc/NIAS_ibv3_296ea.jersey.bim ... done.
Writing 03_qc/NIAS_ibv3_296ea.jersey.bed ... done.

End time: Mon Aug 25 19:11:40 2025
  </code></pre>
</details>
<!-- ===== ìµœì¢… ì‚°ì¶œë¬¼ í•œëˆˆì— ë³´ê¸° ===== -->
<h4> ğŸ“ ìµœì¢… PLINK1 Binary ì„¸íŠ¸ í•œëˆˆì— ë³´ê¸°</h4>
<dl class="qc-glance">
  <dt><code>.bed</code> â€” Binary genotype file</dt>
  <dd>ê° SNP Ã— ê°œì²´ì˜ ìœ ì „ìí˜• ì •ë³´ë¥¼ ì´ì§„(binary) í˜•íƒœë¡œ ì €ì¥ (ì••ì¶• íš¨ìœ¨ì ).</dd>

  <dt><code>.bim</code> â€” Variant information</dt>
  <dd>ê° ë³€ì´ì˜ ì—¼ìƒ‰ì²´, SNP ID, ìœ„ì¹˜, ëŒ€ë¦½ìœ ì „ì(ref/alt) ì •ë³´ë¥¼ í¬í•¨.</dd>

  <dt><code>.fam</code> â€” Sample information</dt>
  <dd>ê° ê°œì²´ì˜ FID/IID, ë¶€Â·ëª¨ ID, ì„±ë³„, phenotype(í˜•ì§ˆ) ì •ë³´ë¥¼ ì €ì¥.</dd>
</dl>
---

## í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ í™œìš© 2ì°¨ í•„í„° ê¸°ì¤€ê°’ ì •í•˜ê¸°

<div class="alert alert-info checklist" role="alert">
  <p><span class="icon">â„¹ï¸</span> <strong>í’ˆì¢…ë³„ PLINK2 QC ë¦¬í¬íŠ¸ ë§Œë“¤ê¸° ë° ë¦¬ë·°</strong>:</p>
  <ul class="tight">
    <li>PLINK2 QC ë³´ê³ ì„œ(<code>.smiss</code>, <code>.vmiss</code>, <code>.hardy</code>, <code>.afreq</code>) ìƒì„±</li>
    <li>RStudioë¡œ QC ë³´ê³ ì„œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë¯¸ë¦¬ë³´ê¸°</li>
    <li>ìƒ˜í”Œë³„/SNPë³„ ìœ ì „ìí˜• ê²°ì¸¡ë¥ (missingness), í•˜ë””â€“ë°”ì¸ë² ë¥´í¬ í‰í˜•(HWE), ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì ë¹ˆë„(MAF)ë¥¼ í’ˆì¢…ë³„ë¡œ ì‹œê°í™”</li>
    <li>ê¸°ì¤€ë¯¸ë‹¬ ìƒ˜í”Œ ë° ë³€ì´ ì •ë³´ CSV ì‘ì„± ë° ê¸°ì¤€ ë¯¸ë‹¬ SNPì— ëŒ€í•œ í†µí•© ìš”ì•½ ìƒì„±</li>
  </ul>
</div>
### 1) [RStudio Terminal] í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ ì¶œë ¥
<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ„</span> <strong>Holstein (í™€ìŠ¤íƒ€ì¸)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 04_split/NIAS_ibv3_296ea.holstein --missing --hardy --freq --out 02_reports/holstein/NIAS_ibv3_296ea.holstein.autosomesX</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>02_reports/holstein/NIAS_ibv3_296ea.holstein.autosomesX.[smiss|vmiss|hardy|afreq]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --freq
  --hardy
  --missing
  --out 02_reports\holstein\NIAS_ibv3_296ea.holstein.autosomesX
  --pfile 04_split\NIAS_ibv3_296ea.holstein

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:27 2025

Random number seed: 1755676407
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
200 samples (0 females, 0 males, 200 ambiguous; 200 founders) loaded from
04_split\NIAS_ibv3_296ea.holstein.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 04_split\NIAS_ibv3_296ea.holstein.pvar.
Note: No phenotype data present.
Calculating sample missingness rates... done.
Calculating allele frequencies... done.
--freq: Allele frequencies (founders only) written to
02_reports\holstein\NIAS_ibv3_296ea.holstein.autosomesX.afreq .
--missing: Sample missing data report written to
02_reports\holstein\NIAS_ibv3_296ea.holstein.autosomesX.smiss .
--missing: Variant missing data report written to
02_reports\holstein\NIAS_ibv3_296ea.holstein.autosomesX.vmiss .
--hardy: Skipping 887 haploid variants.
--hardy: Autosomal Hardy-Weinberg report (founders only) written to
02_reports\holstein\NIAS_ibv3_296ea.holstein.autosomesX.hardy .

End time: Wed Aug 20 16:53:27 2025
  </code></pre>
</details>
<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ‚</span> <strong>Jersey (ì €ì§€)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 04_split/NIAS_ibv3_296ea.jersey --missing --hardy --freq --out 02_reports/jersey/NIAS_ibv3_296ea.jersey.autosomesX</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>02_reports/jersey/NIAS_ibv3_296ea.jersey.autosomesX.[smiss|vmiss|hardy|afreq]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --freq
  --hardy
  --missing
  --out 02_reports\jersey\NIAS_ibv3_296ea.jersey.autosomesX
  --pfile 04_split\NIAS_ibv3_296ea.jersey

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Wed Aug 20 16:53:27 2025

Random number seed: 1755676407
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
96 samples (0 females, 0 males, 96 ambiguous; 96 founders) loaded from
04_split\NIAS_ibv3_296ea.jersey.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 04_split\NIAS_ibv3_296ea.jersey.pvar.
Note: No phenotype data present.
Calculating sample missingness rates... done.
Calculating allele frequencies... done.
--freq: Allele frequencies (founders only) written to
02_reports\jersey\NIAS_ibv3_296ea.jersey.autosomesX.afreq .
--missing: Sample missing data report written to
02_reports\jersey\NIAS_ibv3_296ea.jersey.autosomesX.smiss .
--missing: Variant missing data report written to
02_reports\jersey\NIAS_ibv3_296ea.jersey.autosomesX.vmiss .
--hardy: Skipping 887 haploid variants.
--hardy: Autosomal Hardy-Weinberg report (founders only) written to
02_reports\jersey\NIAS_ibv3_296ea.jersey.autosomesX.hardy .

End time: Wed Aug 20 16:53:28 2025
  </code></pre>
</details>
<!-- ===== ì¸ì ì„¤ëª… (ê°„ë‹¨; íŒŒì¼ í˜•ì‹ ì¬ì„¤ëª… ì—†ìŒ) ===== -->
<section id="plink2-args-compact" class="alert alert-info">
  <h4><span class="icon">âš™ï¸</span> ì‚¬ìš©ëœ PLINK2 ì¸ì(arguments)</h4>
  <dl class="dl-horizontal arglist">
    <dt><code>&#45;&#45;pfile PREFIX</code></dt>
    <dd>PGEN ë°ì´í„°ì…‹ ë¶ˆëŸ¬ì˜¤ê¸° (<code>PREFIX.pgen/pvar/psam</code>).</dd>

    <dt><code>&#45;&#45;missing</code></dt>
    <dd>ìœ ì „ìí˜• ê²°ì¸¡ ë¹„ìœ¨ ê³„ì‚° (<code>.smiss</code> ë° <code>.vmiss</code> íŒŒì¼ ìƒì„±).</dd>

    <dt><code>&#45;&#45;hardy</code></dt>
    <dd>í•˜ë””â€“ë°”ì¸ë² ë¥´í¬ exact test ê²€ì • ì‹¤í–‰ (ìƒì—¼ìƒ‰ì²´ â†’ <code>.hardy</code>, X ì—¼ìƒ‰ì²´ â†’ <code>.hardy.x</code>).</dd>

    <dt><code>&#45;&#45;freq</code></dt>
    <dd>ëŒ€ë¦½ìœ ì „ì ë¹ˆë„ ê³„ì‚° (<code>.afreq</code> íŒŒì¼ ìƒì„±).</dd>

    <dt><code>&#45;&#45;out PREFIX</code></dt>
    <dd>ì¶œë ¥ ê²½ë¡œ/ì ‘ë‘ì–´ ì§€ì • (ë””ë ‰í„°ë¦¬ëŠ” ë¯¸ë¦¬ ì¡´ì¬í•´ì•¼ í•¨).</dd>
  </dl>
</section>

<!-- ===== QC ë¦¬í¬íŠ¸ í•œëˆˆì— ë³´ê¸° ===== -->
<h4>ğŸ“ PLINK2 QC ë¦¬í¬íŠ¸ í•œëˆˆì— ë³´ê¸°</h4>
<dl class="qc-glance">
  <dt><code>.smiss</code> â€” ìƒ˜í”Œ ê²°ì¸¡ë¥ </dt>
  <dd>ê°œì²´ë³„ ìœ ì „ìí˜• ë¯¸í˜¸ì¶œ ë¹„ìœ¨ (<code>F_MISS</code> by sample).</dd>

  <dt><code>.vmiss</code> â€” ë³€ì´ ê²°ì¸¡ë¥ </dt>
  <dd>ë³€ì´ë³„ ìœ ì „ìí˜• ë¯¸í˜¸ì¶œ ë¹„ìœ¨ (ì „ì²´ ìƒ˜í”Œ ê¸°ì¤€, <code>F_MISS</code> by SNP).</dd>

  <dt><code>.hardy</code> / <code>.hardy.x</code> â€” í•˜ë””â€“ë°”ì¸ë² ë¥´í¬ í‰í˜• ê²€ì •</dt>
  <dd>Hardyâ€“Weinberg exact test ê²€ì • Pê°’ (ìƒì—¼ìƒ‰ì²´ / X ì—¼ìƒ‰ì²´).</dd>

  <dt><code>.afreq</code> â€” ëŒ€ë¦½ìœ ì „ì ë¹ˆë„</dt>
  <dd>ë³€ì´ë³„ ëŒ€ì²´(ALT) ëŒ€ë¦½ìœ ì „ì ë¹ˆë„ (<code>.pvar</code> íŒŒì¼ì˜ ëŒ€ë¦½ìœ ì „ì ì‚¬ìš©; ALTëŠ” ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì(minor allele)ê°€ ì•„ë‹ ìˆ˜ ìˆì–´ì„œ ë¹ˆë„ê°€ 0.5 ì´ìƒì¼ ìˆ˜ë„ ìˆìŒ).</dd>
</dl>

### 2) [RStudio Console] ì„¤ì •
```{r, include=FALSE}
# ê¸°ë³¸ì ìœ¼ë¡œ ë³´ê³ ì„œë¥¼ ê¹”ë”í•˜ê²Œ ìœ ì§€
knitr::opts_chunk$set(
  echo = TRUE, message = TRUE, warning = TRUE
)
```

```{r}
# í’ˆì¢…ë³„ ê¸°ë³¸ QC ë³´ê³ ì„œ
# ---------------------------------------------------
# ---- í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¶ˆëŸ¬ì˜¤ê¸°----
need <- c("readr","dplyr","ggplot2")
to_install <- setdiff(need, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install, repos = "https://cloud.r-project.org")
invisible(lapply(need, library, character.only = TRUE))

# ---- ë³´ì¡° í•¨ìˆ˜ & ê¸°ì¤€ê°’(=í•„í„°ë§ ê¸°ì¤€) ----
neglog10 <- function(p) -log10(pmax(p, .Machine$double.xmin))  # -Inf ë°©ì§€

# ì´ëŒ€ë¦½ì„±(biallelic) ë°ì´í„°ì˜ MAF: ALT_FREQS ì‚¬ìš©
# plink2 --freqì˜ ALTëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ì°¸ì¡° ëŒ€ë¦½ìœ ì „ì(.pvar íŒŒì¼ì—ì„œ ì •ì˜ëœ ALT)ì´ë©°, ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì(minor allele)ê°€ ì•„ë‹ ìˆ˜ë„ ìˆìŒ. 

maf_from_afreq <- function(df) {
  stopifnot("ALT_FREQS" %in% names(df))
  df %>%
    mutate(
      # ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜ í›„ [0,1] ë²”ìœ„ë¡œ ë³´ì •
      ALT_FREQS = suppressWarnings(as.numeric(ALT_FREQS)),
      ALT_FREQS = pmin(pmax(ALT_FREQS, 0), 1),
      MAF_calc  = pmin(ALT_FREQS, 1 - ALT_FREQS)
    )
}

# ---- ê¸°ì¤€ê°’ (í•„ìš” ì‹œ ì¡°ì •) ----
mind_thr <- 0.05  # ê°œì²´ ë‹¨ìœ„ ìœ ì „ìí˜• ê²°ì¸¡ë¥ 
geno_thr <- 0.05  # ë³€ì´ ë‹¨ìœ„ ìœ ì „ìí˜• ê²°ì¸¡ë¥ 
hwe_thr  <- 1e-6  # í•˜ë””â€“ë°”ì¸ë² ë¥´í¬(HWE) p-ê°’
maf_thr  <- 0.05  # ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì ë¹ˆë„(MAF)

# ---- ê¸°ë³¸ ê²½ë¡œ & í’ˆì¢… êµ¬ë¶„(ì„œë¸Œë””ë ‰í† ë¦¬ ì„¤ì •ìš©) ----
base_dir <- "02_reports"
breeds   <- c("holstein","jersey")

```
<details class="params-details" id="run-params">
  <summary title="í¼ì¹˜ë ¤ë©´ í´ë¦­">
    <span class="chev" aria-hidden="true"></span>
    ğŸ”§ <strong>ì‹¤í–‰ íŒŒë¼ë¯¸í„°</strong>
    <span class="click-hint">â€” ğŸ‘†í´ë¦­í•˜ì—¬ ë³´ê¸°</span>
  </summary>
  <table class="table table-striped params-table">
    <tbody>
      <tr><td>ê¸°ë³¸ ë””ë ‰í„°ë¦¬ (base_dir)</td><td><code>`r params$base_dir`</code></td></tr>
      <tr><td>í’ˆì¢… ëª©ë¡ (breeds)</td><td><code>`r paste(params$breeds, collapse = ", ")`</code></td></tr>
      <tr><td>ê°œì²´ ë‹¨ìœ„ ê²°ì¸¡ë¥  ê¸°ì¤€ (mind_thr)</td><td><code>`r params$mind_thr`</code></td></tr>
      <tr><td>ë³€ì´ ë‹¨ìœ„ ê²°ì¸¡ë¥  ê¸°ì¤€ (geno_thr)</td><td><code>`r params$geno_thr`</code></td></tr>
      <tr><td>HWE p-ê°’ ê¸°ì¤€ (hwe_thr)</td><td><code>`r format(params$hwe_thr, scientific = TRUE)`</code></td></tr>
      <tr><td>MAF ê¸°ì¤€ (maf_thr)</td><td><code>`r params$maf_thr`</code></td></tr>
    </tbody>
  </table>
</details>

### 3) [RStudio Console] í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ ì ê²€
```{r, include=TRUE}
# í’ˆì¢…ë³„ ìš”ì•½ í–‰ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
summary_rows <- list()

# ---- í’ˆì¢…ë³„ ì‹¤í–‰ ----
# ì „ì²´ í’ˆì¢…(breeds ë²¡í„°: "holstein", "jersey")ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤. 
#   - breeds[1] = "holstein"
#   - breeds[2] = "jersey"
# ì•„ë˜ for ë£¨í”„ì—ì„œ ìë™ìœ¼ë¡œ ë‘ í’ˆì¢…ì´ ë°˜ë³µ ì‹¤í–‰ëœë‹¤. 

# ---- ëª¨ë“  í’ˆì¢… ìë™ ì‹¤í–‰ ----
for (breed in breeds) {
  message("=== í’ˆì¢… ì²˜ë¦¬ ì¤‘: ", breed, " ===")

  prefix <- file.path(base_dir, breed, sprintf("NIAS_ibv3_296ea.%s.autosomesX", breed))
  f_smiss <- paste0(prefix, ".smiss")
  f_vmiss <- paste0(prefix, ".vmiss")
  f_hardy <- paste0(prefix, ".hardy")
  f_afreq <- paste0(prefix, ".afreq")

  out_dir  <- file.path(base_dir, breed)
  figs_dir <- file.path(out_dir, "figs")
  dir.create(figs_dir, showWarnings = FALSE, recursive = TRUE)

  # ---- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ----
  smiss <- readr::read_tsv(f_smiss, show_col_types = FALSE) |>
    dplyr::rename(FID = `#FID`)  # "#FID" -> FID

  vmiss <- readr::read_tsv(f_vmiss, show_col_types = FALSE) |>
    dplyr::rename(CHROM = `#CHROM`)

  hardy <- readr::read_tsv(f_hardy, show_col_types = FALSE) |>
    dplyr::rename(CHROM = `#CHROM`) |>
    dplyr::mutate(minuslog10P = neglog10(P))

  afreq <- readr::read_tsv(f_afreq, show_col_types = FALSE) |>
    dplyr::rename(CHROM = `#CHROM`) |>
    maf_from_afreq()

  message("smiss ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(smiss))
  message("vmiss ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(vmiss))
  message("hardy ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(hardy))
  message("afreq ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(afreq))

  # ---- ê·¸ë˜í”„ ----
  qc_theme <- ggplot2::theme_minimal(base_size = 12) +
    ggplot2::theme(
      axis.title.x = ggplot2::element_text(size = 14, face = "bold"),
      axis.title.y = ggplot2::element_text(size = 14, face = "bold"),
      axis.text.x  = ggplot2::element_text(size = 12),
      axis.text.y  = ggplot2::element_text(size = 12),
      plot.title   = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5)
    )

  p1 <- ggplot2::ggplot(smiss, ggplot2::aes(x = F_MISS)) +
    ggplot2::geom_histogram(bins = 50) +
    ggplot2::geom_vline(xintercept = mind_thr) +
    ggplot2::labs(title = paste0(breed, ": ê°œì²´ ë‹¨ìœ„ ê²°ì¸¡ë¥  (F_MISS)"),
                  x = "F_MISS", y = "ê°œìˆ˜") + qc_theme

  p2 <- ggplot2::ggplot(vmiss, ggplot2::aes(x = F_MISS)) +
    ggplot2::geom_histogram(bins = 60) +
    ggplot2::geom_vline(xintercept = geno_thr) +
    ggplot2::labs(title = paste0(breed, ": ë³€ì´ ë‹¨ìœ„ ê²°ì¸¡ë¥  (F_MISS)"),
                  x = "F_MISS", y = "ê°œìˆ˜") + qc_theme

  p3 <- ggplot2::ggplot(hardy, ggplot2::aes(x = minuslog10P)) +
    ggplot2::geom_histogram(bins = 60) +
    ggplot2::geom_vline(xintercept = -log10(hwe_thr)) +
    ggplot2::labs(title = paste0(breed, ": í•˜ë””-ë°”ì¸ë² ë¥´í¬ ê²€ì • (-log10P)"),
                  x = "-log10(P)", y = "ê°œìˆ˜") + qc_theme

  p4 <- ggplot2::ggplot(afreq, ggplot2::aes(x = MAF_calc)) +
    ggplot2::geom_histogram(bins = 60) +
    ggplot2::geom_vline(xintercept = maf_thr) +
    ggplot2::labs(title = paste0(breed, ": MAF ë¶„í¬"),
                  x = "MAF", y = "ê°œìˆ˜") + qc_theme

  print(p1); print(p2); print(p3); print(p4)

  ggplot2::ggsave(file.path(figs_dir, "smiss_hist.png"), p1, width = 3, height = 3, dpi = 300)
  ggplot2::ggsave(file.path(figs_dir, "vmiss_hist.png"), p2, width = 3, height = 3, dpi = 300)
  ggplot2::ggsave(file.path(figs_dir, "hardy_hist.png"), p3, width = 3, height = 3, dpi = 300)
  ggplot2::ggsave(file.path(figs_dir, "maf_hist.png"),   p4, width = 3, height = 3, dpi = 300)

  # ---- ì´ìƒì¹˜(outlier) í…Œì´ë¸” ----
  assign(paste0("bad_samples_", breed),
         smiss |>
           dplyr::filter(F_MISS > mind_thr) |>
           dplyr::select(FID, IID, F_MISS),
         envir = .GlobalEnv)

  assign(paste0("bad_snps_miss_", breed),
         vmiss |>
           dplyr::filter(F_MISS > geno_thr) |>
           dplyr::select(CHROM, ID, F_MISS),
         envir = .GlobalEnv)

  assign(paste0("bad_snps_hwe_", breed),
         hardy |>
           dplyr::filter(P < hwe_thr) |>
           dplyr::select(CHROM, ID, P),
         envir = .GlobalEnv)

  assign(paste0("bad_snps_maf_", breed),
         afreq |>
           dplyr::filter(MAF_calc < maf_thr) |>
           dplyr::select(CHROM, ID, MAF_calc),
         envir = .GlobalEnv)

  readr::write_csv(get(paste0("bad_samples_",   breed)), file.path(out_dir, paste0("bad_samples_over_mind.", breed, ".csv")))
  readr::write_csv(get(paste0("bad_snps_miss_", breed)), file.path(out_dir, paste0("bad_snps_over_geno.", breed, ".csv")))
  readr::write_csv(get(paste0("bad_snps_hwe_",  breed)), file.path(out_dir, paste0("bad_snps_hwe.", breed, ".csv")))
  readr::write_csv(get(paste0("bad_snps_maf_",  breed)), file.path(out_dir, paste0("bad_snps_low_maf.", breed, ".csv")))

  # ---- í’ˆì¢…ë³„ ë³€ì´ QC ìš”ì•½ ----
  vmiss <- vmiss |> dplyr::mutate(CHROM = as.character(CHROM))
  hardy <- hardy |> dplyr::mutate(CHROM = as.character(CHROM))
  afreq <- afreq |> dplyr::mutate(CHROM = as.character(CHROM))

  variant_qc <- vmiss |>
    dplyr::select(CHROM, ID, F_MISS) |>
    dplyr::left_join(dplyr::select(hardy, CHROM, ID, P),        by = c("CHROM","ID")) |>
    dplyr::left_join(dplyr::select(afreq, CHROM, ID, MAF_calc), by = c("CHROM","ID")) |>
    dplyr::mutate(
      fail_miss = F_MISS > geno_thr,
      fail_hwe  = P < hwe_thr,
      fail_maf  = MAF_calc < maf_thr,
      fail_any  = fail_miss | fail_hwe | fail_maf
    )

  readr::write_csv(variant_qc, file.path(out_dir, paste0("variant_qc_summary.", breed, ".csv")))

  n_fail_any   <- sum(variant_qc$fail_any, na.rm = TRUE)
  n_snps_total <- dplyr::n_distinct(vmiss$ID)
  cat(sprintf("[%s] ì´ SNP ìˆ˜: %s; ê¸°ì¤€ ì‹¤íŒ¨ SNP ìˆ˜: %s (%.2f%%)\n\n",
              breed,
              prettyNum(n_snps_total, big.mark = ","),
              prettyNum(n_fail_any,   big.mark = ","),
              100 * n_fail_any / n_snps_total))

  # ---- ìš”ì•½ í–‰ ----
  samples_over_mind <- sum(smiss$F_MISS > mind_thr, na.rm = TRUE)
  snps_over_geno    <- sum(vmiss$F_MISS > geno_thr, na.rm = TRUE)
  snps_fail_hwe     <- sum(hardy$P < hwe_thr, na.rm = TRUE)
  snps_below_maf    <- sum(afreq$MAF_calc < maf_thr, na.rm = TRUE)

  summary_row <- tibble::tibble(
    breed = breed,
    n_samples = nrow(smiss),
    n_variants = nrow(vmiss),
    samples_over_mind = samples_over_mind,
    snps_over_geno = snps_over_geno,
    snps_fail_hwe = snps_fail_hwe,
    snps_below_maf_threshold = snps_below_maf,
    snps_fail_any_filter = n_fail_any,
    pct_fail_any = round(100 * n_fail_any / nrow(vmiss), 3)
  )

  readr::write_csv(summary_row, file.path(out_dir, "qc_summary_counts.csv"))
  summary_rows[[breed]] <- summary_row
}

```

### 4) [RStudio Console] í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ ìš”ì•½ ê²°ê³¼ í†µí•©
```{r}
summary_all <- dplyr::bind_rows(summary_rows)
readr::write_csv(summary_all, file.path(base_dir, "qc_summary_by_breed.csv"))
```

```{r, echo=FALSE}
knitr::kable(summary_all, digits = 3) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed"),
                            full_width = FALSE)
```
<div class="alert alert-success outputs" role="alert"> <h4 class="alert-heading">ğŸ“ ìµœì¢…ì¶œë ¥ë¬¼</h4> <h5 class="mt-2">í’ˆì¢…ë³„ (<code>02_reports/&lt;breed&gt;/</code> ë‚´ë¶€)</h5> <table class="table table-striped table-condensed outputs-table"> <thead> <tr><th>ìœ„ì¹˜</th><th>íŒŒì¼ ì´ë¦„</th><th>í˜•ì‹</th><th>ì„¤ëª…</th></tr> </thead> <tbody> <tr> <td><code>02_reports/&lt;breed&gt;/figs/</code></td> <td> <code>smiss_hist.png</code>, <code>vmiss_hist.png</code>,<br> <code>hardy_hist.png</code>, <code>maf_hist.png</code> </td> <td>PNG</td> <td>íˆìŠ¤í† ê·¸ë¨ ê·¸ë¦¼: ê°œì²´/ë³€ì´ ê²°ì¸¡ë¥ , í•˜ë””â€“ë°”ì¸ë² ë¥´í¬(HWE, âˆ’log10P), MAF</td> </tr> <tr> <td><code>02_reports/&lt;breed&gt;/</code></td> <td> <code>bad_samples_over_mind.&lt;breed&gt;.csv</code><br> <code>bad_snps_over_geno.&lt;breed&gt;.csv</code><br> <code>bad_snps_hwe.&lt;breed&gt;.csv</code><br> <code>bad_snps_low_maf.&lt;breed&gt;.csv</code> </td> <td>CSV</td> <td>ì§€í‘œë³„ ì´ìƒì¹˜ ëª©ë¡ (ê°œì²´ ê²°ì¸¡ë¥ , SNP ê²°ì¸¡ë¥ , HWE, MAF)</td> </tr> <tr> <td><code>02_reports/&lt;breed&gt;/</code></td> <td><code>variant_qc_summary.&lt;breed&gt;.csv</code></td> <td>CSV</td> <td>ë³€ì´ ë‹¨ìœ„ ìš”ì•½ (í”Œë˜ê·¸ í¬í•¨: <code>fail_miss</code>, <code>fail_hwe</code>, <code>fail_maf</code>, <code>fail_any</code>)</td> </tr> <tr> <td><code>02_reports/&lt;breed&gt;/</code></td> <td><code>qc_summary_counts.csv</code></td> <td>CSV</td> <td>í’ˆì¢…ë³„ ìš”ì•½ (ê°œì²´/ë³€ì´ ìˆ˜ ë° ê¸°ì¤€ ì‹¤íŒ¨ ê°œìˆ˜)</td> </tr> </tbody> </table> <h5>í†µí•© (ì „ì²´ í’ˆì¢…)</h5> <ul class="list-unstyled mb-0"> <li>ğŸ“š <strong>ì „ì²´ í’ˆì¢… ìš”ì•½</strong>: <code>02_reports/qc_summary_by_breed.csv</code> (CSV)</li> </ul> </div> 

### 5) QC ë¦¬í¬íŠ¸ ê²°ê³¼ ë‹¤ì‹œë³´ê¸°
```{r outputs-recap, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
breed_icon <- function(b) {
  b <- tolower(trimws(b))
  if (b == "holstein") return("&#x1F404;")  # ğŸ„
  if (b == "jersey")   return("&#x1F402;")  # ğŸ‚
  return("&#x1F9C0;")                       # ğŸ§€
}
breed_class <- function(b) paste0("breed-", tolower(trimws(b)))

if (exists("summary_all") && nrow(summary_all) > 0) {
  out <- c('<div class="recap-grid">')
  for (i in seq_len(nrow(summary_all))) {
    r <- summary_all[i, ]
    pct <- as.numeric(r$pct_fail_any)              # ì‹¤íŒ¨ ë¹„ìœ¨ (%)
    fail_n  <- r$snps_fail_any_filter
    pass_n  <- max(0, r$n_variants - fail_n)
    pass_pct <- max(0, 100 - pct)

    icon <- breed_icon(r$breed)
    cls  <- breed_class(r$breed)

    out <- c(out,
      sprintf('<div class="recap-card %s">', cls),
      sprintf('<h5>%s %s</h5>', icon, r$breed),
      '<div class="recap-badges">',
      sprintf('<span class="badge">ìƒ˜í”Œ ê°œìˆ˜ %s</span>', prettyNum(r$n_samples, big.mark=",")),
      sprintf('<span class="badge">ë³€ì´ ê°œìˆ˜ %s</span>',  prettyNum(r$n_variants, big.mark=",")),'</div>',
      # tree (no footer)
      sprintf('<div class="breakdown-tree"><div class="tree-root"><span class="badge badge-fail"><strong>ì‹¤íŒ¨ ë³€ì´ %s (%.2f%%)</strong></span></div><div class="tree-branches"><div class="branch"><span class="pill pill-miss">miss <strong>%s</strong></span></div><div class="branch"><span class="pill pill-hwe">HWE <strong>%s</strong></span></div><div class="branch"><span class="pill pill-maf">low MAF <strong>%s</strong></span></div></div></div>',
              prettyNum(fail_n, big.mark=","), pct,
              prettyNum(r$snps_over_geno, big.mark=","),    # miss
              prettyNum(r$snps_fail_hwe,  big.mark=","),    # HWE
              prettyNum(r$snps_below_maf_threshold, big.mark=",")), # low MAF
      # dual progress bar with labels
      sprintf('<div class="progress progress-dual" role="img" aria-label="ì‹¤íŒ¨ %.2f%%, í†µê³¼ %.2f%%">', pct, pass_pct),
      sprintf('<div class="progress-seg fail seg-striped" style="width: %.2f%%" data-label="ì‹¤íŒ¨ %s (%.2f%%)"></div>', pct,      prettyNum(fail_n, big.mark=","), pct),
      sprintf('<div class="progress-seg pass"              style="width: %.2f%%" data-label="í†µê³¼ %s (%.2f%%)"></div>', pass_pct, prettyNum(pass_n,  big.mark=","), pass_pct),
      '</div>',  # close progress
      '</div>'   # close recap-card
    )
  }
  out <- c(out, '</div>')  # close recap-grid
  knitr::asis_output(paste(out, collapse = "\n"))
} else {
  knitr::asis_output('<div class="recap-empty"><em>í‘œì‹œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</em></div>')
}

```

---

## ìµœì¢… PLINK1 Binary ì„¸íŠ¸ ë‹¤ì‹œ ë§Œë“¤ê¸°

<!-- ==== 4. ìµœì¢… ë°ì´í„°ì…‹ ë‹¤ì‹œ ë§Œë“¤ê¸° â€” ìš”ì•½ íŒ¨ë„ ==== -->

```{=html}
<!-- ì—¬ê¸°ì— ìˆœìˆ˜ HTMLì„ ë„£ìœ¼ë©´ ì½”ë“œê°€ ì•„ë‹ˆë¼ ì‹¤ì œ HTMLë¡œ ë Œë”ë§ë©ë‹ˆë‹¤ -->
<div class="rebuild-summary">
  <h4 class="rs-title">ğŸ” ìµœì¢… ì„¸íŠ¸ ì¬ìƒì„± ìš”ì•½</h4>
  <p class="rs-desc">ë°”ë€ QC ê¸°ì¤€ê°’(íŠ¹íˆ per-population <code>minor allele count (MAC) â‰¥ 10</code>)ì„ ì ìš©í•˜ì—¬ ìµœì¢… <code>PLINK1 binary</code> íŒŒì¼ì„ ë‹¤ì‹œ ìƒì„±í•œë‹¤.</p>

  <div class="rs-cols">
    <div class="rs-col">
      <h5>ğŸ„ Holstein <span class="rs-tag rs-tag-change">ë³€ê²½</span></h5>
      <ul class="rs-chips">
        <li><span class="k">mind</span> <b>0.05</b></li>
        <li><span class="k">geno</span> <b>0.05</b></li>
        <li><span class="k">hwe</span> <b>1e-6</b></li>
        <li class="changed"><span class="k">mac</span> <b>10</b> <em>(MAF 0.025)</em></li>
      </ul>
    </div>

    <div class="rs-col">
      <h5>ğŸ‚ Jersey <span class="rs-tag rs-tag-change">ë³€ê²½</span></h5>
      <ul class="rs-chips">
        <li><span class="k">mind</span> <b>0.05</b></li>
        <li><span class="k">geno</span> <b>0.05</b></li>
        <li><span class="k">hwe</span> <b>1e-6</b></li>
        <li class="changed"><span class="k">mac</span> <b>10</b> <em>(MAF 0.052)</em></li>
      </ul>
    </div>
  </div>

  <div class="rs-note">
    <p>ğŸ“ <b>Per-population MAC â‰¥ 10</b> í•´ì„:</p>
    <ul>
      <li>Holstein (n=200 â†’ 400 chromosomes): MAC 10 â‰ˆ MAF <code>10/400 = 0.025</code></li>
      <li>Jersey (n=96 â†’ 192 chromosomes): MAC 10 â‰ˆ MAF <code>10/192 â‰ˆ 0.052</code></li>
    </ul>
    <p>ì¦‰, í‘œë³¸ í¬ê¸°ì— ë”°ë¼ ì‹¤ì§ˆ MAF ì»·ì´ ìë™ìœ¼ë¡œ ë§ì¶°ì§„ë‹¤. </p>
  </div>
</div>
```

<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ„</span> <strong>7-1) Holstein (í™€ìŠ¤íƒ€ì¸)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 04_split/NIAS_ibv3_296ea.holstein --mind 0.05 --geno 0.05 --mac 10 --hwe 1e-6 --make-bed --out 03_qc/NIAS_ibv3_296ea.holstein</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>03_qc/NIAS_ibv3_296ea.holstein.[bed|bim|fam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log (Holstein) â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --geno 0.05
  --hwe 1e-6
  --mac 10
  --make-bed
  --mind 0.05
  --out 03_qc/NIAS_ibv3_296ea.holstein
  --pfile 04_split/NIAS_ibv3_296ea.holstein

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Sun Aug 24 20:03:32 2025

Random number seed: 1756033412
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
200 samples (0 females, 0 males, 200 ambiguous; 200 founders) loaded from
04_split/NIAS_ibv3_296ea.holstein.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 04_split/NIAS_ibv3_296ea.holstein.pvar.
Note: No phenotype data present.
Calculating sample missingness rates... done.
0 samples removed due to missing genotype data (--mind).
200 samples (0 females, 0 males, 200 ambiguous; 200 founders) remaining after
main filters.
Calculating allele frequencies... done.
--geno: 193 variants removed due to missing genotype data.
--hwe: 37 variants removed due to Hardy-Weinberg exact test (founders only).
3660 variants removed due to allele frequency threshold(s)
(--maf/--max-maf/--mac/--max-mac).
43686 variants remaining after main filters.
Writing 03_qc/NIAS_ibv3_296ea.holstein.fam ... done.
Writing 03_qc/NIAS_ibv3_296ea.holstein.bim ... done.
Writing 03_qc/NIAS_ibv3_296ea.holstein.bed ... done.

End time: Sun Aug 24 20:03:33 2025
    </code></pre>
  </details>


<div class="alert alert-info cmd" role="alert">
  <p><span class="icon">ğŸ‚</span> <strong>7-2) Jersey (ì €ì§€)</strong></p>
  <pre><code class="language-bash">plink2 --pfile 04_split/NIAS_ibv3_296ea.jersey --mind 0.05 --geno 0.05 --mac 10 --hwe 1e-6 --make-bed --out 03_qc/NIAS_ibv3_296ea.jersey</code></pre>
  <p><em>ìƒì„±ë˜ëŠ” ì¶œë ¥ íŒŒì¼:</em><br>
  <code>03_qc/NIAS_ibv3_296ea.jersey.[bed|bim|fam]</code></p>
</div>
<details class="alert alert-secondary log">
  <summary style="cursor:pointer; font-size:1.1em; font-weight:600">
    ğŸ“„ PLINK2 run log (Jersey) â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
  </summary>
  <pre class="no-copy"><code class="language-text">
PLINK v2.0.0-a.6.21 64-bit (6 Aug 2025)
Options in effect:
  --geno 0.05
  --hwe 1e-6
  --mac 10
  --make-bed
  --mind 0.05
  --out 03_qc/NIAS_ibv3_296ea.jersey
  --pfile 04_split/NIAS_ibv3_296ea.jersey

Hostname: haesu
Working directory: G:\Rhome\NIAS_ibv3_296ea\PLINK_120825_0322
Start time: Sun Aug 24 20:03:46 2025

Random number seed: 1756033426
65463 MiB RAM detected; reserving 32731 MiB for main workspace.
Using up to 16 threads (change this with --threads).
96 samples (0 females, 0 males, 96 ambiguous; 96 founders) loaded from
04_split/NIAS_ibv3_296ea.jersey.psam.
chrSet header line: 29 autosome pairs.
47576 variants loaded from 04_split/NIAS_ibv3_296ea.jersey.pvar.
Note: No phenotype data present.
Calculating sample missingness rates... done.
0 samples removed due to missing genotype data (--mind).
96 samples (0 females, 0 males, 96 ambiguous; 96 founders) remaining after main
filters.
Calculating allele frequencies... done.
--geno: 154 variants removed due to missing genotype data.
--hwe: 18 variants removed due to Hardy-Weinberg exact test (founders only).
12329 variants removed due to allele frequency threshold(s)
(--maf/--max-maf/--mac/--max-mac).
35075 variants remaining after main filters.
Writing 03_qc/NIAS_ibv3_296ea.jersey.fam ... done.
Writing 03_qc/NIAS_ibv3_296ea.jersey.bim ... done.
Writing 03_qc/NIAS_ibv3_296ea.jersey.bed ... done.

End time: Sun Aug 24 20:03:46 2025
    </code></pre>
  </details>

<div class="alert alert-success comparison" role="alert">
  <p><span class="icon">ğŸ“Š</span> <strong>QC summary comparison: Holstein vs Jersey</strong></p>

  <table class="table table-sm table-bordered rs-compare">
    <thead>
      <tr>
        <th>Metric</th>
        <th>ğŸ„ Holstein</th>
        <th>ğŸ‚ Jersey</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Samples loaded</td>
        <td><b>200</b> (200 founders)</td>
        <td><b>96</b> (96 founders)</td>
      </tr>
      <tr>
        <td>Variants loaded</td>
        <td><b>47,576</b></td>
        <td><b>47,576</b></td>
      </tr>
      <tr>
        <td>Removed by <code>--mind 0.05</code></td>
        <td><b>0</b></td>
        <td><b>0</b></td>
      </tr>
      <tr>
        <td>Removed by <code>--geno 0.05</code></td>
        <td><b>193</b></td>
        <td><b>154</b></td>
      </tr>
      <tr>
        <td>Removed by <code>--hwe 1e-6</code></td>
        <td><b>37</b></td>
        <td><b>18</b></td>
      </tr>
      <tr>
        <td>Removed by <code>--mac 10</code></td>
        <td><b>3,660</b></td>
        <td><b>12,329</b></td>
      </tr>
      <tr class="final-row">
        <td><b>Final variants</b></td>
        <td><b>43,686</b></td>
        <td><b>35,075</b></td>
      </tr>
    </tbody>
  </table>
</div>

<hr style="margin:1.25rem 0" />

## ğŸ‰ QC ê³¼ì • ì™„ë£Œ

<div class="alert alert-success" role="alert" style="margin-top:.5rem">
  <h4 class="alert-heading" style="margin-top:0;margin-bottom:.5rem">âœ… QC ì ˆì°¨ë¥¼ ëê¹Œì§€ ì˜ ë§ˆì³¤ë‹¤!</h4>
  <p style="margin-bottom:.75rem">
    ëª¨ë“  ë‹¨ê³„(ë°ì´í„° ë³€í™˜ â†’ ì˜¤ë¥˜ ë³€ì´ ì œê±° â†’ 1ì°¨/2ì°¨ í•„í„°ë§ â†’ í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ ë¦¬ë·° í›„ 2ì°¨ í•„í„°ë§)ë¥¼ ê±°ì³
    ìµœì¢… <code>PLINK1 binary</code> ì„¸íŠ¸(<code>.bed/.bim/.fam</code>)ë¥¼ ë§Œë“¤ì—ˆë‹¤. ğŸ€
  </p>
  <hr style="margin:.75rem 0" />
  <p class="mb-0">ì´ì œ ì´ ìœ ì „ìí˜• ë°ì´í„°ë¡œ GWAS ë¶„ì„ì„ ì‹œì‘í•  ìˆ˜ ìˆë‹¤. ğŸš€ğŸ”¥</p>
</div>

<hr style="margin:1.25rem 0" />

## ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ë³´ê¸°
<div class="alert alert-secondary" role="alert" style="margin-top:1rem">
  <p><span style="font-size:1.1em">ğŸ’» <strong>Plink Genotype QC</strong></span></p>

  <details>
    <summary style="cursor:pointer;font-size:1.15em; font-weight:600">
      <code>cmd_plink_qc.bat</code> íŒŒì¼ â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
    </summary>
    <pre><code class="language-bash">:: ============================================
:: Plink genotype data QC (run in RStudio Terminal on Windows CMD)
:: ============================================

:: 0) ì¶œë ¥ í´ë” ìƒì„±
mkdir 00_import 01_autosomesX 02_reports 03_qc 04_split

:: 1) PED/MAP â†’ PGEN ë³€í™˜
::    --cow        : ì†Œ(cattle) ë¹ŒíŠ¸/ì—¼ìƒ‰ì²´ ê·œì¹™ ì‚¬ìš©
::    --pedmap     : ì…ë ¥ prefix (NIAS_ibv3_296ea.ped/.map)
::    --sort-vars  : ë³€ì´ë¥¼ ìœ ì „ì²´ ì¢Œí‘œ ìˆœìœ¼ë¡œ ì •ë ¬
::    --make-pgen  : ì¶œë ¥ í˜•ì‹ì€ PLINK2(.pgen/.pvar/.psam)
::    --out        : ì¶œë ¥ ì ‘ë‘ì–´
plink2 --cow --pedmap NIAS_ibv3_296ea --sort-vars --make-pgen --out 00_import\NIAS_ibv3_296ea

:: 2) PVARì—ì„œ REF/ALTê°€ ë‘˜ ë‹¤ '.'ì¸ ë¬¸ì œ ë³€ì´ ëª©ë¡ ì¶”ì¶œ ë° ì œê±°
::    (ì´ ìƒíƒœëŠ” "Duplicate allele code" ì˜¤ë¥˜ë¥¼ ìœ ë°œí•¨)

:: 2-1) REF(4ì—´)ê³¼ ALT(5ì—´)ê°€ ëª¨ë‘ '.'ì¸ ì „ì²´ í–‰ ì €ì¥(í—¤ë” ì œì™¸)
awk -F '\t' "NR>1 && $4==\".\" && $5==\".\"" 00_import\NIAS_ibv3_296ea.pvar > bad_refalt_ids_both_strict.txt

:: 2-2) ê°™ì€ ì¡°ê±´ì˜ ë³€ì´ ID(3ì—´)ë§Œ ì¶”ì¶œ
awk -F '\t' "NR>1 && $4==\".\" && $5==\".\" {print $3}" 00_import\NIAS_ibv3_296ea.pvar > bad_refalt_ids.txt

:: 2-3) ë¬¸ì œ ë³€ì´ ì œì™¸ í›„ ê¹¨ë—í•œ pfileë¡œ ì €ì¥
plink2 --pfile 00_import/NIAS_ibv3_296ea --exclude bad_refalt_ids.txt --make-pgen --out 00_import/NIAS_ibv3_296ea.clean

:: 3) 1ì°¨ í•„í„°(í•„ìˆ˜): ì˜¤í† ì†œ+Xì—¼ìƒ‰ì²´, biallelic, ë‹¨ì¼í˜• ì œê±°, ì¤‘ë³µ ID ì œê±° â†’ ì´í›„ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•˜ëŠ” autosomesX ìƒì„±
::    --chr 1-29,X         : ì—¼ìƒ‰ì²´ 1â€“29 + Xë§Œ ì‚¬ìš©
::    --max-alleles 2      : ëŒ€ë¦½ìœ ì „ì â‰¤ 2 (biallelicë§Œ ìœ ì§€)
::    --mac 1              : ìµœì†Œ ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì ìˆ˜ â‰¥ 1 (ë‹¨ì¼í˜• ë³€ì´ ì œê±°)
::    --rm-dup force-first : ì¤‘ë³µ ë³€ì´ ë°œê²¬ ì‹œ ì²« ë²ˆì§¸ ê²ƒë§Œ ìœ ì§€ (ì¢Œí‘œ/allele ê¸°ì¤€)
::    --sort-vars          : ì¢Œí‘œ ìˆœìœ¼ë¡œ ì •ë ¬
::    --make-pgen          : pgen/pvar/psam ì¶œë ¥
::    --out                : autosomesX ì„¸íŠ¸ ì¶œë ¥ ìœ„ì¹˜

plink2 --pfile 00_import/NIAS_ibv3_296ea.clean --chr 1-29,X --max-alleles 2 --mac 1 --rm-dup force-first --sort-vars --make-pgen --out 01_autosomesX/NIAS_ibv3_296ea.autosomesX

:: 3-ì¶”ê°€) í’ˆì¢…ë³„ ë°ì´í„°ì…‹ ë¶„ë¦¬ ì¤€ë¹„: Holstein/Jersey IID ëª©ë¡ì„ FID IID ë‘ ì—´ë¡œ ë³€í™˜
::        (holstein.txt / jersey.txtì—ëŠ” IIDë§Œ ìˆë‹¤ê³  ê°€ì •, .psamì—ì„œ FIDë¥¼ ë§¤ì¹­í•´ì˜¨ë‹¤)

:: Holstein: ì²« ë²ˆì§¸ íŒŒì¼(holstein.txt)ì˜ IIDë¥¼ í•´ì‹œì— ì €ì¥í•˜ê³ , .psamì—ì„œ ì¼ì¹˜í•˜ëŠ” IID í–‰ì˜ FID IIDë¥¼ ì¶œë ¥
awk "NR==FNR {iid[$1]=1; next} FNR>1 && ($2 in iid) {print $1, $2}" holstein.txt 01_autosomesX\NIAS_ibv3_296ea.autosomesX.psam > holstein_ids.txt

:: Jersey: ë™ì¼ ì²˜ë¦¬
awk "NR==FNR {iid[$1]=1; next} FNR>1 && ($2 in iid) {print $1, $2}" jersey.txt 01_autosomesX\NIAS_ibv3_296ea.autosomesX.psam > jersey_ids.txt

:: 4) í’ˆì¢…ë³„ ì„œë¸Œì…‹ pfile ë§Œë“¤ê¸°

:: Holstein ì„œë¸Œì…‹ pfile ìƒì„± (--keep: FID IID ëª©ë¡ì˜ ìƒ˜í”Œë§Œ ìœ ì§€)
plink2 --pfile 01_autosomesX/NIAS_ibv3_296ea.autosomesX --keep holstein_ids.txt --make-pgen --out 04_split/NIAS_ibv3_296ea.holstein

:: Jersey ì„œë¸Œì…‹ pfile ìƒì„±
plink2 --pfile 01_autosomesX/NIAS_ibv3_296ea.autosomesX --keep jersey_ids.txt --make-pgen --out 04_split/NIAS_ibv3_296ea.jersey

:: 5) í’ˆì¢…ë³„ ê¸°ë³¸ QC ë¦¬í¬íŠ¸ ë§Œë“¤ê¸°
::    --missing : ìƒ˜í”Œ/ë³€ì´ ê²°ì¸¡ë¥ (missing genotype rate)
::    --hardy   : HWE(í•˜ë””â€“ë°”ì¸ë² ë¥´ê·¸) ê²€ì •
::    --freq    : ëŒ€ë¦½ìœ ì „ì ë¹ˆë„

:: 5-1) í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ í´ë” ìƒì„±
mkdir 02_reports\holstein 02_reports\jersey

:: Holstein QC ë¦¬í¬íŠ¸
plink2 --pfile 04_split\NIAS_ibv3_296ea.holstein --missing --hardy --freq --out 02_reports\holstein\NIAS_ibv3_296ea.holstein.autosomesX

:: Jersey QC ë¦¬í¬íŠ¸
plink2 --pfile 04_split\NIAS_ibv3_296ea.jersey --missing --hardy --freq --out 02_reports\jersey\NIAS_ibv3_296ea.jersey.autosomesX

:: 6) RStudioì—ì„œ í’ˆì¢…ë³„ QC ë¦¬í¬íŠ¸ í™•ì¸ ë° 2ì°¨ í•„í„° ê°’ ê²°ì •
:: check_genotype_data.R script ì‹¤í–‰

:: 7) í’ˆì¢…ë³„ 2ì°¨ í•„í„° ì ìš©(ê°’ì€ ì—°êµ¬ ëª©ì /ìƒ˜í”Œ í¬ê¸°ì— ë§ê²Œ ì¡°ì •)
::    --mind 0.05 : ê°œì²´ ê²°ì¸¡ë¥  â‰¤ 5%ë§Œ ìœ ì§€(0.05 ì´ˆê³¼ ê°œì²´ ì œì™¸)
::    --geno 0.05 : ë³€ì´ ê²°ì¸¡ë¥  â‰¤ 5%ë§Œ ìœ ì§€(0.05 ì´ˆê³¼ ë³€ì´ ì œì™¸)
::    --mac 10: MAF â‰¥ 0.025 (Holstein) ë° 0.052(Jersey) ë³€ì´ë§Œ ìœ ì§€
::    --hwe  1e-6 : HWE p < 1e-6 ë³€ì´ ì œì™¸
::    --make-bed  : PLINK1 ë°”ì´ë„ˆë¦¬(.bed/.bim/.fam) íŒŒì¼ë¡œ ì €ì¥

:: Holstein
plink2 --pfile 04_split\NIAS_ibv3_296ea.holstein --mind 0.05 --geno 0.05 --mac 10 --hwe 1e-6 --make-bed --out 03_qc/NIAS_ibv3_296ea.holstein

:: Jersey 
plink2 --pfile 04_split\NIAS_ibv3_296ea.jersey --mind 0.05 --geno 0.05 --mac 10 --hwe 1e-6 --make-bed --out 03_qc/NIAS_ibv3_296ea.jersey</code></pre>
  </details>
</div>
<div class="alert alert-secondary" role="alert" style="margin-top:1rem">
  <p><span style="font-size:1.1em">ğŸ“˜ <strong>Breed-wise QC Report Review</strong></span></p>

  <details>
    <summary style="cursor:pointer;font-size:1.15em; font-weight:600">
      <code>check_genotype_data.R</code> íŒŒì¼ â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
    </summary>
    <pre><code class="language-r"># í’ˆì¢…ë³„ ê¸°ë³¸ QC ë³´ê³ ì„œ
# ---------------------------------------------------
# ---- í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ë¶ˆëŸ¬ì˜¤ê¸°----
need <- c("readr","dplyr","ggplot2")
to_install <- setdiff(need, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install, repos = "https://cloud.r-project.org")
invisible(lapply(need, library, character.only = TRUE))

# ---- ë³´ì¡° í•¨ìˆ˜ & ê¸°ì¤€ê°’(=í•„í„°ë§ ê¸°ì¤€) ----
neglog10 <- function(p) -log10(pmax(p, .Machine$double.xmin))  # -Inf ë°©ì§€

# ì´ëŒ€ë¦½ì„±(biallelic) ë°ì´í„°ì˜ MAF: ALT_FREQS ì‚¬ìš©
# plink2 --freqì˜ ALTëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë¹„ì°¸ì¡° ëŒ€ë¦½ìœ ì „ì(.pvar íŒŒì¼ì—ì„œ ì •ì˜ëœ ALT)ì´ë©°, ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì(minor allele)ê°€ ì•„ë‹ ìˆ˜ë„ ìˆìŒ. 

maf_from_afreq <- function(df) {
  stopifnot("ALT_FREQS" %in% names(df))
  df %>%
    mutate(
      # ìˆ«ìí˜•ìœ¼ë¡œ ë³€í™˜ í›„ [0,1] ë²”ìœ„ë¡œ ë³´ì •
      ALT_FREQS = suppressWarnings(as.numeric(ALT_FREQS)),
      ALT_FREQS = pmin(pmax(ALT_FREQS, 0), 1),
      MAF_calc  = pmin(ALT_FREQS, 1 - ALT_FREQS)
    )
}

# ---- ê¸°ì¤€ê°’ (í•„ìš” ì‹œ ì¡°ì •) ----
mind_thr <- 0.05  # ê°œì²´ ë‹¨ìœ„ ìœ ì „ìí˜• ê²°ì¸¡ë¥ 
geno_thr <- 0.05  # ë³€ì´ ë‹¨ìœ„ ìœ ì „ìí˜• ê²°ì¸¡ë¥ 
hwe_thr  <- 1e-6  # í•˜ë””â€“ë°”ì¸ë² ë¥´í¬(HWE) p-ê°’
maf_thr  <- 0.05  # ì†Œìˆ˜ ëŒ€ë¦½ìœ ì „ì ë¹ˆë„(MAF)

# ---- ê¸°ë³¸ ê²½ë¡œ & í’ˆì¢… êµ¬ë¶„(ì„œë¸Œë””ë ‰í† ë¦¬ ì„¤ì •ìš©) ----
base_dir <- "02_reports"
breeds   <- c("holstein","jersey")

# í’ˆì¢…ë³„ ìš”ì•½ í–‰ì„ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
summary_rows <- list()

# ---- í’ˆì¢…ë³„ ì‹¤í–‰ ----
# ì „ì²´ í’ˆì¢…(breeds ë²¡í„°: "holstein", "jersey")ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤. 
#   - breeds[1] = "holstein"
#   - breeds[2] = "jersey"
# ì•„ë˜ for ë£¨í”„ì—ì„œ ìë™ìœ¼ë¡œ ë‘ í’ˆì¢…ì´ ë°˜ë³µ ì‹¤í–‰ëœë‹¤. 
# ---- ëª¨ë“  í’ˆì¢… ìë™ ì‹¤í–‰ ----
for (breed in breeds) {
  message("=== í’ˆì¢… ì²˜ë¦¬ ì¤‘: ", breed, " ===")

  prefix <- file.path(base_dir, breed, sprintf("NIAS_ibv3_296ea.%s.autosomesX", breed))
  f_smiss <- paste0(prefix, ".smiss")
  f_vmiss <- paste0(prefix, ".vmiss")
  f_hardy <- paste0(prefix, ".hardy")
  f_afreq <- paste0(prefix, ".afreq")

  out_dir  <- file.path(base_dir, breed)
  figs_dir <- file.path(out_dir, "figs")
  dir.create(figs_dir, showWarnings = FALSE, recursive = TRUE)

  # ---- ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ----
  smiss <- readr::read_tsv(f_smiss, show_col_types = FALSE) |>
    dplyr::rename(FID = `#FID`)  # "#FID" -> FID

  vmiss <- readr::read_tsv(f_vmiss, show_col_types = FALSE) |>
    dplyr::rename(CHROM = `#CHROM`)

  hardy <- readr::read_tsv(f_hardy, show_col_types = FALSE) |>
    dplyr::rename(CHROM = `#CHROM`) |>
    dplyr::mutate(minuslog10P = neglog10(P))

  afreq <- readr::read_tsv(f_afreq, show_col_types = FALSE) |>
    dplyr::rename(CHROM = `#CHROM`) |>
    maf_from_afreq()

  message("smiss ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(smiss))
  message("vmiss ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(vmiss))
  message("hardy ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(hardy))
  message("afreq ë°ì´í„° ì•ë¶€ë¶„:"); print(utils::head(afreq))

  # ---- ê·¸ë˜í”„ ----
  qc_theme <- ggplot2::theme_minimal(base_size = 12) +
    ggplot2::theme(
      axis.title.x = ggplot2::element_text(size = 14, face = "bold"),
      axis.title.y = ggplot2::element_text(size = 14, face = "bold"),
      axis.text.x  = ggplot2::element_text(size = 12),
      axis.text.y  = ggplot2::element_text(size = 12),
      plot.title   = ggplot2::element_text(size = 16, face = "bold", hjust = 0.5)
    )

  p1 <- ggplot2::ggplot(smiss, ggplot2::aes(x = F_MISS)) +
    ggplot2::geom_histogram(bins = 50) +
    ggplot2::geom_vline(xintercept = mind_thr) +
    ggplot2::labs(title = paste0(breed, ": ê°œì²´ ë‹¨ìœ„ ê²°ì¸¡ë¥  (F_MISS)"),
                  x = "F_MISS", y = "ê°œìˆ˜") + qc_theme

  p2 <- ggplot2::ggplot(vmiss, ggplot2::aes(x = F_MISS)) +
    ggplot2::geom_histogram(bins = 60) +
    ggplot2::geom_vline(xintercept = geno_thr) +
    ggplot2::labs(title = paste0(breed, ": ë³€ì´ ë‹¨ìœ„ ê²°ì¸¡ë¥  (F_MISS)"),
                  x = "F_MISS", y = "ê°œìˆ˜") + qc_theme

  p3 <- ggplot2::ggplot(hardy, ggplot2::aes(x = minuslog10P)) +
    ggplot2::geom_histogram(bins = 60) +
    ggplot2::geom_vline(xintercept = -log10(hwe_thr)) +
    ggplot2::labs(title = paste0(breed, ": í•˜ë””-ë°”ì¸ë² ë¥´í¬ ê²€ì • (-log10P)"),
                  x = "-log10(P)", y = "ê°œìˆ˜") + qc_theme

  p4 <- ggplot2::ggplot(afreq, ggplot2::aes(x = MAF_calc)) +
    ggplot2::geom_histogram(bins = 60) +
    ggplot2::geom_vline(xintercept = maf_thr) +
    ggplot2::labs(title = paste0(breed, ": MAF ë¶„í¬"),
                  x = "MAF", y = "ê°œìˆ˜") + qc_theme

  print(p1); print(p2); print(p3); print(p4)

  ggplot2::ggsave(file.path(figs_dir, "smiss_hist.png"), p1, width = 3, height = 3, dpi = 300)
  ggplot2::ggsave(file.path(figs_dir, "vmiss_hist.png"), p2, width = 3, height = 3, dpi = 300)
  ggplot2::ggsave(file.path(figs_dir, "hardy_hist.png"), p3, width = 3, height = 3, dpi = 300)
  ggplot2::ggsave(file.path(figs_dir, "maf_hist.png"),   p4, width = 3, height = 3, dpi = 300)

  # ---- ì´ìƒì¹˜(outlier) í…Œì´ë¸” ----
  assign(paste0("bad_samples_", breed),
         smiss |>
           dplyr::filter(F_MISS > mind_thr) |>
           dplyr::select(FID, IID, F_MISS),
         envir = .GlobalEnv)

  assign(paste0("bad_snps_miss_", breed),
         vmiss |>
           dplyr::filter(F_MISS > geno_thr) |>
           dplyr::select(CHROM, ID, F_MISS),
         envir = .GlobalEnv)

  assign(paste0("bad_snps_hwe_", breed),
         hardy |>
           dplyr::filter(P < hwe_thr) |>
           dplyr::select(CHROM, ID, P),
         envir = .GlobalEnv)

  assign(paste0("bad_snps_maf_", breed),
         afreq |>
           dplyr::filter(MAF_calc < maf_thr) |>
           dplyr::select(CHROM, ID, MAF_calc),
         envir = .GlobalEnv)

  readr::write_csv(get(paste0("bad_samples_",   breed)), file.path(out_dir, paste0("bad_samples_over_mind.", breed, ".csv")))
  readr::write_csv(get(paste0("bad_snps_miss_", breed)), file.path(out_dir, paste0("bad_snps_over_geno.", breed, ".csv")))
  readr::write_csv(get(paste0("bad_snps_hwe_",  breed)), file.path(out_dir, paste0("bad_snps_hwe.", breed, ".csv")))
  readr::write_csv(get(paste0("bad_snps_maf_",  breed)), file.path(out_dir, paste0("bad_snps_low_maf.", breed, ".csv")))

  # ---- í’ˆì¢…ë³„ ë³€ì´ QC ìš”ì•½ ----
  vmiss <- vmiss |> dplyr::mutate(CHROM = as.character(CHROM))
  hardy <- hardy |> dplyr::mutate(CHROM = as.character(CHROM))
  afreq <- afreq |> dplyr::mutate(CHROM = as.character(CHROM))

  variant_qc <- vmiss |>
    dplyr::select(CHROM, ID, F_MISS) |>
    dplyr::left_join(dplyr::select(hardy, CHROM, ID, P),        by = c("CHROM","ID")) |>
    dplyr::left_join(dplyr::select(afreq, CHROM, ID, MAF_calc), by = c("CHROM","ID")) |>
    dplyr::mutate(
      fail_miss = F_MISS > geno_thr,
      fail_hwe  = P < hwe_thr,
      fail_maf  = MAF_calc < maf_thr,
      fail_any  = fail_miss | fail_hwe | fail_maf
    )

  readr::write_csv(variant_qc, file.path(out_dir, paste0("variant_qc_summary.", breed, ".csv")))

  n_fail_any   <- sum(variant_qc$fail_any, na.rm = TRUE)
  n_snps_total <- dplyr::n_distinct(vmiss$ID)
  cat(sprintf("[%s] ì´ SNP ìˆ˜: %s; ê¸°ì¤€ ì‹¤íŒ¨ SNP ìˆ˜: %s (%.2f%%)\n\n",
              breed,
              prettyNum(n_snps_total, big.mark = ","),
              prettyNum(n_fail_any,   big.mark = ","),
              100 * n_fail_any / n_snps_total))

  # ---- ìš”ì•½ í–‰ ----
  samples_over_mind <- sum(smiss$F_MISS > mind_thr, na.rm = TRUE)
  snps_over_geno    <- sum(vmiss$F_MISS > geno_thr, na.rm = TRUE)
  snps_fail_hwe     <- sum(hardy$P < hwe_thr, na.rm = TRUE)
  snps_below_maf    <- sum(afreq$MAF_calc < maf_thr, na.rm = TRUE)

  summary_row <- tibble::tibble(
    breed = breed,
    n_samples = nrow(smiss),
    n_variants = nrow(vmiss),
    samples_over_mind = samples_over_mind,
    snps_over_geno = snps_over_geno,
    snps_fail_hwe = snps_fail_hwe,
    snps_below_maf_threshold = snps_below_maf,
    snps_fail_any_filter = n_fail_any,
    pct_fail_any = round(100 * n_fail_any / nrow(vmiss), 3)
  )

  readr::write_csv(summary_row, file.path(out_dir, "qc_summary_counts.csv"))
  summary_rows[[breed]] <- summary_row
}

summary_all <- dplyr::bind_rows(summary_rows)
readr::write_csv(summary_all, file.path(base_dir, "qc_summary_by_breed.csv"))</code></pre>

  </details>
</div>
