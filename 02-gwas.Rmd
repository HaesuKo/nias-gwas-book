---
title: "GWAS ì ˆì°¨"
author:
  - name: "ê³ í•´ìˆ˜, ë†í•™ë°•ì‚¬"
    affiliation: "êµ­ë¦½ì¶•ì‚°ê³¼í•™ì›(NIAS) ê°€ì¶•ê°œëŸ‰í‰ê°€ê³¼"
    email: "kosoo91@korea.kr"
date: "`r format(Sys.Date())`"
output:
  rmdformats::readthedown:
    toc_depth: 3
    highlight: kate
    includes:
      in_header:
        - copy-button.html
    css: custom.css
lang: ko
encoding: UTF-8
resource_files:
  - copy-button.html
---
# GWAS ì ˆì°¨

ê°œìš”
<div class="alert alert-info checklist" role="alert">
  <p><span class="icon">ğŸ“‹</span> <strong>ë‹¨ê³„ë³„ íŠœí† ë¦¬ì–¼: Rì—ì„œ GWAS ìˆ˜í–‰</strong></p>
  <ul class="tight">
    <li>í•„ìš” íŒ¨í‚¤ì§€ ì„¤ì¹˜/ë¡œë”©</li>
    <li>PLINK ìœ ì „ìí˜• ë°ì´í„° & í‘œí˜„í˜• ë°ì´í„° ë¡œë”© ë° ì •ë¦¬</li>
    <li>GRM ê³„ì‚° ë° ì‹œê°í™”</li>
    <li>lme4breeding + GWASTools + GENESIS ê¸°ë°˜ GWAS ê·€ë¬´ëª¨í˜•(Null model) ì í•©</li>
    <li>ë‹¨ì¼ ë§ˆì»¤ ì—°ê´€ì„± ê²€ì •, P ê°’ ë³´ì •, ê²°ê³¼ ì‹œê°í™”</li>
  </ul>
</div>

```{r setup, include=FALSE}
# ì „ì—­ ì²­í¬ ì˜µì…˜(ê°€ë…ì„±/ì¬í˜„ì„±)
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  fig.align = "center",
  fig.retina = 2
)
set.seed(20250829)
```

## íŒ¨í‚¤ì§€ ì„¤ì¹˜ & ë¡œë”©
```{r packages}
# ---- ì„¤ì¹˜ì–´ì‹œìŠ¤í„´íŠ¸ -------------------------------------------------------
cran_pkgs <- c("genio", "qqman", "sommer", "lme4breeding", "dplyr", "CMplot", "stringr", "ggplot2", "tibble", "readr")
bioc_pkgs <- c("GENESIS","GWASTools","BiocParallel")

if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

install_if_missing <- function(pkgs, installer) {
  need <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
  if (length(need)) installer(need, ask = FALSE)
}

install_if_missing(cran_pkgs, install.packages)
install_if_missing(bioc_pkgs, BiocManager::install)

# ---- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ------------------------------------------------------
library(genio)
library(GENESIS)
library(GWASTools)
library(qqman)
library(CMplot)
library(lme4breeding)
library(sommer)
library(dplyr)
library(stringr)
library(ggplot2)
library(tibble)
```

## ê²½ë¡œ/ì…ë ¥ ì •ì˜
```{r}
breed        <- "holstein"
plink_prefix <- "03_qc/NIAS_ibv3_296ea.holstein"
pheno_file   <- "NIAS_ibv3_296ea_pheno.csv"

report_dir <- file.path("05_gwas", breed)
figs_dir   <- file.path(report_dir, "figs")
gwas_dir   <- file.path(report_dir, "gwas")
tables_dir <- file.path(report_dir, "tables")
for (d in c(report_dir, figs_dir, gwas_dir, tables_dir)) dir.create(d, recursive = TRUE, showWarnings = FALSE)
```

## PLINK binary ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
```{r plink}
# read_plink()ëŠ” SNP x Sample í–‰ë ¬(X), bim(ë§ˆì»¤ì •ë³´), fam(ê°œì²´ì •ë³´)ì„ ë¶ˆëŸ¬ì˜¨ë‹¤.
plink <- read_plink(plink_prefix)

X <- plink$X             # í–‰: SNP, ì—´: ìƒ˜í”Œ, ê°’: 0/1/2
bim <- plink$bim         # chr, id, pos, alt, ref ë“±
fam <- plink$fam         # family/sample id ë“±

# ë¯¸ë¦¬ë³´ê¸°
X[1:5, 1:5]
head(bim)
head(fam)
```

## í‘œí˜„í˜• ë°ì´í„° ë¡œë”© & ì •ë ¬
```{r}
pheno <- readr::read_csv(pheno_file, show_col_types = FALSE)

sample_id_chr <- colnames(X)  # PLINK ì—´ì´ ìƒ˜í”Œ ID
scanID <- seq_along(sample_id_chr)

pheno_ord <- pheno[match(sample_id_chr, pheno$individual_id), , drop = FALSE]
stopifnot(!any(is.na(pheno_ord$individual_id)))
pheno_ord$sample_id <- sample_id_chr
pheno_ord$scanID    <- scanID
stopifnot(identical(as.character(pheno_ord$individual_id), pheno_ord$sample_id))
# ë¯¸ë¦¬ë³´ê¸°
str(pheno_ord)

# í‘œí˜„í˜• ë¶„í¬ í™•ì¸
# --- ë¶„ì„í•  í˜•ì§ˆì„ ì´ ë³€ìˆ˜ì— ì§€ì • ---
single_trait <- "days_in_milk"

p=ggplot(pheno_ord, aes(x = .data[[single_trait]])) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "grey70", color = "white") +
  geom_density(linewidth = 1) +
  labs(
    title = paste("Distribution of", single_trait),
    x = single_trait, 
    y = "Density"
  ) +
  theme_minimal()

# ë³€ìˆ˜ì— ì €ì¥ëœ í”Œë¡¯ í™•ì¸
print(p)
# ggsave() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í”Œë¡¯ì„ png íŒŒì¼ë¡œ ì €ì¥
ggsave(
  filename = file.path(figs_dir, paste0("pheno_distribution_", single_trait, ".png")),
  plot = p,
  width = 6,
  height = 4,
  dpi = 300
)
```

## GRM(ìœ ì „ì²´ ê´€ê³„ í–‰ë ¬) ê³„ì‚° & ê°„ë‹¨ ì‹œê°í™”
```{r grm}
# A.matì€ -1/0/1 ì½”ë”©ëœ genotype matrix ì´ìš©
G_mat <- t(X)              # ìƒ˜í”Œ x SNP
colnames(G_mat) <- rownames(X)
rownames(G_mat) <- sample_id_chr

G_code <- G_mat - 1        # 0/1/2 -> -1/0/1
KI     <- sommer::A.mat(G_code)
# ìˆ˜ì¹˜ì•ˆì •ì„±(ì•„ì£¼ ì‘ì€ ridge)
diag(KI) <- diag(KI) + 1e-4

# scanID ê¸°ì¤€ì˜ dimnames ì§€ì •
rownames(KI) <- as.character(scanID)
colnames(KI) <- as.character(scanID)

stopifnot(
  identical(rownames(KI), as.character(scanID)),
  identical(colnames(KI), as.character(scanID))
)

# ìƒìœ„ 5x5 í™•ì¸
KI[1:5, 1:5]

# íˆíŠ¸ë§µ
colfunc <- grDevices::colorRampPalette(c("steelblue4","springgreen","yellow"))

png(file.path(report_dir, "A_matrix_heatmap.png"), width=2000, height=1400, res=200)
stats::heatmap(KI, col = colfunc(100), Colv = "Rowv", symmetric = TRUE)
dev.off()
```
<p><em>GRM íˆíŠ¸ë§µ</em></p>
```{r grm-plot, echo=FALSE}
knitr::include_graphics(file.path(report_dir, "A_matrix_heatmap.png"))
```

## GWAS ë¶„ì„ìš© ë°ì´í„° ê°ì²´ ë§Œë“¤ê¸°
```{r}
bim <- cbind(index = seq_len(nrow(bim)), bim)
stopifnot(all.equal(rownames(X), bim$id))
stopifnot(all.equal(colnames(X), pheno_ord$sample_id))

rownames(X) <- bim$index
colnames(X) <- scanID

# GENESIS íŒ¨í‚¤ì§€ì—ì„œ ìš”êµ¬í•˜ëŠ” ë°ì´í„° ê°ì²´ ë§Œë“¤ê¸°
mg <- GWASTools::MatrixGenotypeReader(
  genotype   = X,
  snpID      = bim$index,
  chromosome = as.integer(bim$chr),
  position   = as.integer(bim$pos),
  scanID     = scanID,
  autosomeCode = 1L:29L,
  XchromCode   = 30L, YchromCode = 31L, XYchromCode = 32L, MchromCode = 33L
)
# ìœ ì „ìí˜• ë°ì´í„° ê°ì²´ ìƒì„±
genoData <- GWASTools::GenotypeData(mg)
# í‘œí˜„í˜• ë°ì´í„° ê°ì²´ ìƒì„±
scanAnno <- GWASTools::ScanAnnotationDataFrame(pheno_ord)
# ê°ì²´ êµ¬ì¡° í™•ì¸
str(genoData)
str(scanAnno@data)   
```

## GWAS ê·€ë¬´ëª¨í˜• ì í•© ë° ìœ ì „ë ¥(SNP heritability) ê³„ì‚°
```{r}
# --- ë¶„ì„í•  í˜•ì§ˆì„ ì´ ë³€ìˆ˜ì— ì§€ì • ---
single_trait <- "days_in_milk"

# ë¶„ì„í•  í˜•ì§ˆì´ ë°ì´í„°ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸. ì—†ìœ¼ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê³  ì¤‘ë‹¨
stopifnot(single_trait %in% colnames(scanAnno@data))

# --- ë°ì´í„° ì „ì²˜ë¦¬ ---

# 1. ëª¨ë¸ì—ì„œ íš¨ê³¼ë¥¼ ë¶„ì„í•  ë³€ìˆ˜ë“¤ì„ factor(ë²”ì£¼í˜• ë³€ìˆ˜)ë¡œ ë³€í™˜
pheno_ord$farm_id <- as.factor(pheno_ord$farm_id)
pheno_ord$scanID <- as.factor(pheno_ord$scanID)

# 2. ë¶„ì„í•  í˜•ì§ˆ(days_in_milk)ì— ê²°ì¸¡ì¹˜(NA)ê°€ ìˆëŠ” ìƒ˜í”Œì„ ì œê±°í•˜ì—¬
#    ìµœì¢… ë¶„ì„ ë°ì´í„°ì…‹ 'PH'ë¥¼ ìƒì„±
#    droplevels() í•¨ìˆ˜ëŠ” PH ë°ì´í„°ì…‹ì— ë” ì´ìƒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒ˜í”Œì´ë‚˜ ë†ì¥ì˜ ë ˆë²¨ ì •ë³´ë¥¼ ì œê±°
PH <- droplevels(subset(pheno_ord, !is.na(days_in_milk)))

# 3. Kinship í–‰ë ¬(KI)ì„ ìµœì¢… ë¶„ì„ ë°ì´í„°ì…‹ 'PH'ì— ë§ì¶° ìë¥¸ë‹¤.
#    ë°˜ë“œì‹œ 'PH'ì˜ ìƒ˜í”Œ ëª©ë¡ê³¼ ìˆœì„œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ë¼ì•¼,
#    í‘œí˜„í˜• ë°ì´í„°ì™€ Kinship ë°ì´í„°ì˜ ìƒ˜í”Œì´ 1:1ë¡œ ì •í™•í•˜ê²Œ ì¼ì¹˜í•œë‹¤.
K_scan <- KI[levels(PH$scanID), levels(PH$scanID)]

# ë†ì¥ íš¨ê³¼ì™€ ê°œì²´ë³„ ìœ ì „ íš¨ê³¼ë¥¼ ì„ì˜ íš¨ê³¼(random effect)ë¡œ ì„¤ì •í•˜ì—¬ ëª¨ë¸ì„ ë§Œë“ ë‹¤.
# lmebreed í•¨ìˆ˜ëŠ” í˜ˆì—°ê´€ê³„(kinship)ë¥¼ ê³ ë ¤í•œ í˜¼í•© ëª¨ë¸ì„ ì í•©í•´ì¤€ë‹¤.
mix <- lme4breeding::lmebreed(
  # ëª¨ë¸ ê³µì‹: days_in_milkë¥¼ ê°œì²´ íš¨ê³¼(scanID)ì™€ ë†ì¥ íš¨ê³¼(farm_id)ë¡œ ì„¤ëª…
  days_in_milk ~ (1|scanID) + (1|farm_id),
  
  # relmat ì¸ì: scanIDì˜ ì„ì˜ íš¨ê³¼ëŠ” K_scan í–‰ë ¬ì— ì •ì˜ëœ ìœ ì „ì  ê´€ê³„ë¥¼ ë”°ë¥´ë„ë¡ ì§€ì •í•œë‹¤.
  relmat  = list(scanID = K_scan),
  
  # verbose=TRUE: ëª¨ë¸ ê³„ì‚° ê³¼ì •ì„ í™”ë©´ì— ì¶œë ¥
  verbose = TRUE,
  
  # data ì¸ì: ëª¨ë¸ì— ì‚¬ìš©í•  ë°ì´í„°ì…‹ìœ¼ë¡œ PHë¥¼ ì§€ì •
  data    = PH
)

# ëª¨ë¸ ë¶„ì„ ê²°ê³¼ ìš”ì•½ë³¸ ì¶œë ¥
summary(mix)

```

```{=html}
<!-- ===== í—¤ë” ë°”ê°€ ìˆëŠ” ì¹´ë“œ ë²„ì „ ===== -->
<style>
.gwas-card{
  border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; margin:18px 0;
  background:#fcfcff; box-shadow:0 1px 0 rgba(17,24,39,.04);
}
.gwas-header{
  padding:10px 16px; background:#e0e7ff; border-bottom:1px solid #c7d2fe;
  display:flex; align-items:center; gap:.6rem;
}
.gwas-header .title{ font-weight:700; }
.gwas-body{ padding:16px 18px; }

/* ë‚˜ë¨¸ì§€ ìŠ¤íƒ€ì¼ì€ ìœ„ì™€ ë™ì¼ */
.gwas-sub{ color:#4b5563; margin:0 0 .8rem; font-size:.95rem; }
.gwas-dl{ margin:0; }
.gwas-dl dt{ font-weight:700; margin-top:.6rem; }
.gwas-dl dd{ margin:.15rem 0 .5rem 0; color:#374151; }
.gwas-kpis{ display:flex; flex-wrap:wrap; gap:.5rem; margin:.6rem 0 .2rem; }
.kpi{ display:inline-flex; align-items:center; gap:.35rem;
      padding:.3rem .55rem; border-radius:999px; background:#c7d2fe; font-weight:600;
      border:1px solid #818cf8; color:#1f2937; }
.badge{ font-size:.8rem; padding:.05rem .35rem; border-radius:6px; background:#9ca3af; color:#fff; }
.gwas-grid{ display:grid; grid-template-columns: 1fr; gap:.6rem; }
@media(min-width:700px){ .gwas-grid{ grid-template-columns:1fr 1fr; } }
.gwas-table{ width:100%; border-collapse:collapse; font-size:.95rem; }
.gwas-table th, .gwas-table td{ padding:.4rem .55rem; border-bottom:1px solid #e5e7eb; text-align:left; }
.gwas-note{ margin-top:.6rem; color:#374151; }
.hr-soft{ border:0; border-top:1px dashed #e5e7eb; margin:1rem 0; }
</style>

<div class="gwas-card" id="null-model-summary">
  <div class="gwas-header">
    <div class="title icon-wrap"><span class="emoji">â“</span><span>Null model ìš”ì•½ â€” days_in_milk</span></div>
    <div class="meta" style="margin-left:auto; font-size:.9rem; color:#374151;">Vg/Vc/Ve & hÂ²</div>
  </div>
  <div class="gwas-body">
    <h4 style="margin:.2rem 0 .8rem;"> 1. ì„ì˜ íš¨ê³¼ (Random effects) ë¶„ì„</h4>
    <p class="gwas-sub">ì´ ë¶€ë¶„ì´ ê²°ê³¼ í•´ì„ì˜ í•µì‹¬ì´ë‹¤. <code>days_in_milk</code> í˜•ì§ˆì˜ ì „ì²´ ë³€ì´ê°€ ì–´ë–¤ ìš”ì¸ë“¤ë¡œ êµ¬ì„±ë˜ì–´ ìˆëŠ”ì§€ ë³´ì—¬ì¤€ë‹¤.</p>

    <div class="gwas-dl">
      <div class="gwas-kpis">
        <span class="kpi">scanID Variance: <b>3794.3</b> <span class="badge">Vg</span></span>
        <span class="kpi">farm_id Variance: <b>289.4</b> <span class="badge">Vc</span></span>
        <span class="kpi">Residual Variance: <b>17284.7</b> <span class="badge">Ve</span></span>
      </div>

      <dl class="gwas-dl">
        <dt>scanID (ìœ ì „ íš¨ê³¼)</dt>
        <dd>ê°œì²´ ê°„ ìœ ì „ì  ì°¨ì´(í˜ˆì—°ê´€ê³„ ê³ ë ¤)ë¡œ ì¸í•œ ë¶„ì‚° â†’ <b>ìœ ì „ ë¶„ì‚°(Vg)</b>.</dd>
        <dt>farm_id (ë†ì¥ íš¨ê³¼)</dt>
        <dd>ë†ì¥ ê°„ í™˜ê²½ ì°¨ì´ë¡œ ì¸í•œ ë¶„ì‚° â†’ <b>ê³µí†µ í™˜ê²½ ë¶„ì‚°(Vc)</b>.</dd>
        <dt>Residual (ì”ì°¨)</dt>
        <dd>ìœ ì „ ë° ë†ì¥ íš¨ê³¼ë¡œ ì„¤ëª…ë˜ì§€ ì•ŠëŠ” ë‚˜ë¨¸ì§€ ì˜¤ì°¨ â†’ <b>í™˜ê²½ ë¶„ì‚°(Ve)</b>.</dd>
      </dl>
    </div>

    <hr class="hr-soft"/>

    <h4 style="margin:.2rem 0 .8rem;">ğŸ“ 2. ìœ ì „ë ¥ (Heritability) ê³„ì‚°</h4>
    <div class="gwas-grid">
      <div>
        <table class="gwas-table">
          <thead><tr><th>ì„±ë¶„</th><th>ê°’</th><th>ì„¤ëª…</th></tr></thead>
          <tbody>
            <tr><td>Vg</td><td>3794.3</td><td>ìœ ì „ ë¶„ì‚°</td></tr>
            <tr><td>Vc</td><td>289.4</td><td>ë†ì¥(ê³µí†µ í™˜ê²½) ë¶„ì‚°</td></tr>
            <tr><td>Ve</td><td>17284.7</td><td>ì”ì°¨(í™˜ê²½) ë¶„ì‚°</td></tr>
            <tr><td>Vp = Vg + Vc + Ve</td><td><b>21368.4</b></td><td>ì „ì²´ í‘œí˜„í˜• ë¶„ì‚°</td></tr>
            <tr><td>hÂ² = Vg / Vp</td><td><b>0.178</b></td><td>ìœ ì „ë ¥</td></tr>
          </tbody>
        </table>
      </div>
      <div class="gwas-note">
        <p><b>ê²°ë¡ :</b> <code>days_in_milk</code>ì˜ <b>SNP ìœ ì „ë ¥ì€ ì•½ 17.8%</b>ë¡œ ì¶”ì •ëœë‹¤. ì´ëŠ” ì´ í˜•ì§ˆì˜ ì „ì²´ ë³€ì´ ì¤‘ ì•½ 17.8%ê°€ ìš°ë¦¬ê°€ ì¸¡ì •í•œ SNP ë§ˆì»¤ë¡œ ì„¤ëª…ë˜ëŠ” ìœ ì „ì  ìš”ì¸ì— ì˜í•´ ê²°ì •ëœë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.</p>
        <p>ì¶”ê°€ë¡œ, ë†ì¥ í™˜ê²½ì´ ì„¤ëª…í•˜ëŠ” ë³€ì´ì˜ ë¹„ìœ¨ì€ 289.4 / 21368.4 â‰ˆ <b>1.4%</b>ë¡œ ìƒëŒ€ì ìœ¼ë¡œ ì‘ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.</p>
      </div>
    </div>
  </div>
</div>
```

### í•¨ìˆ˜ë¥¼ ì´ìš©í•œ ìœ ì „ë ¥ ê³„ì‚°
```{r}
# VarCorr() í•¨ìˆ˜ë¡œ ëª¨ë¸('mix')ì—ì„œ ë¶„ì‚° ì„±ë¶„(Variance Components)ì„ ì¶”ì¶œ
vc <- VarCorr(mix)
print(vc, comp = c("Variance"))

# ì”ì°¨ ë¶„ì‚°(Residual variance)ì„ ì¶”ì¶œ
# VarCorr ê²°ê³¼ì˜ ì†ì„±(attribute) "sc"ëŠ” ì”ì°¨ì˜ í‘œì¤€í¸ì°¨ì´ë¯€ë¡œ ì œê³±í•˜ì—¬ ë¶„ì‚°ì„ êµ¬í•œë‹¤. 
ve <- attr(VarCorr(mix), "sc")^2

# SNP ìœ ì „ë ¥(h2) ê³„ì‚°
# h2 = ìœ ì „ë¶„ì‚° / (ìœ ì „ë¶„ì‚° + ë†ì¥ë¶„ì‚° + ì”ì°¨ë¶„ì‚°)
h2 <- vc$scanID / (vc$scanID +  vc$farm_id + ve)
print(paste("SNP Heritability (h2):", base::as.numeric(h2)))

# ì „ì²´ í‘œí˜„í˜• ë¶„ì‚° ì¤‘ ë†ì¥ íš¨ê³¼(farm ID)ê°€ ì°¨ì§€í•˜ëŠ” ë¶„ì‚° ë¹„ìœ¨ ê³„ì‚°
farm_var <- vc$farm_id / (vc$scanID + vc$farm_id + ve)
print(paste("Farm Variance ratio:", base::as.numeric(farm_var)))
```

## GWAS ìµœì¢… null ëª¨í˜• ì í•© ë° GWAS
```{r}
# --- ë¶„ì„í•  í˜•ì§ˆì„ ì´ ë³€ìˆ˜ì— ì§€ì • ---
single_trait <- "days_in_milk"

# ë¶„ì„í•  í˜•ì§ˆì´ ë°ì´í„°ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸. ì—†ìœ¼ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê³  ì¤‘ë‹¨
stopifnot(single_trait %in% colnames(scanAnno@data))

# ê·€ë¬´ëª¨í˜•
null_single <- GENESIS::fitNullModel(
  x        = scanAnno,
  outcome  = single_trait,
  cov.mat  = list(gen = KI),
  family   = "gaussian"
)

# ëª¨í˜•ì—ì„œ ì¶”ì •ëœ ë¶„ì‚° ì„±ë¶„(ìœ ì „ë¶„ì‚°, ì”ì°¨ë¶„ì‚°)ì„ í™•ì¸
null_single$varComp 
# SNP heritability ê³„ì‚° (h2, CI value)
GENESIS::varCompCI(null_single, prop = TRUE)                             
```

```{r, results='hide'}
# GWAS ì‹¤í–‰
# ìœ ì „ì²´ ë°ì´í„°ë¥¼ **ë¸”ë¡ ë‹¨ìœ„(ì—¬ê¸°ì„œëŠ” 10,000 SNPì”©)**ë¡œ ìˆœì°¨ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì´í„°ë ˆì´í„° ìƒì„±: ë©”ëª¨ë¦¬ ì‚¬ìš©ì„ ì¤„ì´ê¸° ìœ„í•¨
genoIt <- GWASTools::GenotypeBlockIterator(genoData, snpBlock = 10000)
# ìœ„ì—ì„œ ì í•©í•œ ê·€ë¬´ëª¨í˜•ì„ ê³ ì •í•œ ìƒíƒœì—ì„œ, ê° SNPì— ëŒ€í•´ ë‹¨ì¼ë³€ëŸ‰ Score testë¡œ ì—°ê´€ì„±ì„ ê³„ì‚°
assoc_single <- GENESIS::assocTestSingle(
  genoIt, null.model = null_single, BPPARAM = BiocParallel::SerialParam()
)

# ---- P-ê°’ ë³´ì • & ìœ ì˜ SNP ì„ ë³„ ---------------------------------
assoc_single$p_adj_BH=p.adjust(assoc_single$Score.pval, method="BH")
assoc_single$p_adj_bonferroni=p.adjust(assoc_single$Score.pval, method="bonferroni")

# ì €ì¥
saveRDS(assoc_single, file = file.path(gwas_dir, paste0("assoc_", single_trait, ".rds")))
readr::write_csv(assoc_single, file.path(tables_dir, paste0("assoc_", single_trait, ".csv")))

head(assoc_single, 5)
```

```{r assoc-single-table, echo=FALSE, message=FALSE, warning=FALSE}
# 1. ê° ì»¬ëŸ¼ì— ëŒ€í•œ ì„¤ëª…ì„ ë‹´ì€ ë²¡í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
column_notes_assoc <- c(
  "SNP ê³ ìœ  ID (ì¸ë±ìŠ¤)",
  "ì—¼ìƒ‰ì²´ ë²ˆí˜¸",
  "ì—¼ìƒ‰ì²´ ë‚´ ìœ„ì¹˜ (base pair)",
  "í•´ë‹¹ SNP ë¶„ì„ì— ì‚¬ìš©ëœ ê°œì²´ ìˆ˜",
  "ëŒ€ë¦½ìœ ì „ì ë¹ˆë„ (Allele Frequency)",
  "ë¶€ëŒ€ë¦½ìœ ì „ì ê°œìˆ˜ (Minor Allele Count)",
  "ì—°ê´€ì„± ê²€ì •ì˜ Score í†µê³„ëŸ‰",
  "Score í†µê³„ëŸ‰ì˜ í‘œì¤€ ì˜¤ì°¨",
  "í‘œì¤€í™”ëœ Score í†µê³„ëŸ‰ (Z-ê°’)",
  "ì—°ê´€ì„± ê²€ì •ì˜ P-ê°’",
  "ëŒ€ë¦½ìœ ì „ìì˜ íš¨ê³¼ ì¶”ì •ì¹˜ (Effect Size)",
  "íš¨ê³¼ ì¶”ì •ì¹˜ì˜ í‘œì¤€ ì˜¤ì°¨",
  "í•´ë‹¹ SNPì´ ì„¤ëª…í•˜ëŠ” í‘œí˜„í˜• ë¶„ì‚°ì˜ ë¹„ìœ¨ (PVE)",
  "BH ë°©ë²•ìœ¼ë¡œ ë³´ì •ëœ P-ê°’ (FDR)",
  "Bonferroni ë°©ë²•ìœ¼ë¡œ ë³´ì •ëœ P-ê°’"
)

# 2. ì „ì²´ ê²°ê³¼ëŠ” ë§¤ìš° í¬ë¯€ë¡œ, ìƒìœ„ 10ê°œ í–‰ë§Œ ì˜ë¼ì„œ ì¶œë ¥ìš© ë°ì´í„°ë¡œ ë§Œë“­ë‹ˆë‹¤.
assoc_head <- head(assoc_single, 5)

# 3. ì¶œë ¥ìš© ë°ì´í„°ì˜ ì»¬ëŸ¼ ì´ë¦„ì— ê°ì£¼ ê¸°í˜¸(^a^, ^b^, ...)ë¥¼ ë¶™ì…ë‹ˆë‹¤.
assoc_for_print <- assoc_head
colnames(assoc_for_print) <- paste0(colnames(assoc_head), " ^", letters[1:ncol(assoc_head)], "^")

# 4. kable, kable_styling, footnote, scroll_box í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ìµœì¢… í…Œì´ë¸”ì„ ë§Œë“­ë‹ˆë‹¤.
knitr::kable(
  assoc_for_print,
  digits = 3,
  caption = "GWAS ì—°ê´€ ë¶„ì„ ê²°ê³¼ (5ê°œ SNP ì˜ˆì‹œ)",
  escape = FALSE # ê°ì£¼ ê¸°í˜¸ë¥¼ ìœ—ì²¨ìë¡œ ë³€í™˜í•˜ê¸° ìœ„í•´ í•„ìˆ˜
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  kableExtra::footnote(
    alphabet = column_notes_assoc,
    footnote_as_chunk = TRUE,
    title_format = "bold"
  ) %>%
  # í…Œì´ë¸”ì´ ê°€ë¡œë¡œ ê¸¸ê¸° ë•Œë¬¸ì—, 100% ë„ˆë¹„ì˜ ìŠ¤í¬ë¡¤ ë°•ìŠ¤ì— ë„£ì–´ì¤ë‹ˆë‹¤.
  kableExtra::scroll_box(width = "100%")
```

### Null modelì´ë€? ì™œ ë¨¼ì € ì í•©í•˜ëŠ”ê°€? {#nullmodel-explainer}

::: {.alert .alert-info .null-explainer}

### ğŸ“ ëª¨í˜•ì‹

ì „ì²´(í˜¼í•©) ëª¨í˜•  
\[
y = X\beta + Zu + G\gamma + \varepsilon
\]

Null ëª¨í˜•(ê²€ì •í•  SNP ì œê±°)  
\[
y = X\beta + Zu + \varepsilon
\]

**ëª¨í˜•í•­ í’€ì´**

- \(y\) : ê´€ì¸¡í•œ í˜•ì§ˆ ê°’(ì˜ˆ: days_in_milk).  
- \(X\) : **ê³ ì •íš¨ê³¼ ì„¤ê³„í–‰ë ¬(ì…ë ¥ í–‰ë ¬)** â€” ì ˆí¸(1), ì„±ë³„/ì—°ë ¹, ì£¼ì„±ë¶„(PC) ë“±ì˜ ê³µë³€ëŸ‰ ì—´ë¡œ êµ¬ì„±.  
- \(\beta\) : ê³ ì •íš¨ê³¼ ê³„ìˆ˜(ê³µë³€ëŸ‰ì˜ í‰ê· ì ì¸ ì˜í–¥ í¬ê¸°).  
- \(Z\) : **ì„ì˜íš¨ê³¼ ì¸ì‹œë˜ìŠ¤ í–‰ë ¬** â€” ê°œì²´ê°€ ì–´ë–¤ ë ˆë²¨(ê°œì²´ ìì‹ /ë†ì¥ ë“±)ì— ì†í•˜ëŠ”ì§€ 0/1ë¡œ í‘œì‹œ.  
- \(u\) : ì„ì˜íš¨ê³¼ ë²¡í„°.  
  - ê°œì²´ ìœ ì „íš¨ê³¼ëŠ” **GRM \(K\)**(ì¹œì¡±ë„ í–‰ë ¬)ë¡œ ìƒê´€êµ¬ì¡°ë¥¼ ë°˜ì˜í•´ ëª¨ë¸ë§.  
  - ë†ì¥ íš¨ê³¼ì²˜ëŸ¼ ì„œë¡œ ë…ë¦½Â·ë¶„ì‚° ë™ì¼ë¡œ ë³´ëŠ” íš¨ê³¼ëŠ” **í•­ë“±í–‰ë ¬ \(I\)**(ìƒê´€ 0, ë¶„ì‚° ë™ì¼)ë¡œ ë‘ .  
- \(G\) : **ê²€ì • ì¤‘ì¸ ë‹¨ì¼ SNP**ì˜ ìœ ì „ìí˜•(0/1/2 ë˜ëŠ” í†µê³„ì ìœ¼ë¡œ ì¶”ì •ëœ ìœ ì „ìëŸ‰, dosage). `assocTestSingle()`ê°€ SNPë§ˆë‹¤ ì´ \(G\)ë¥¼ ë°”ê¿”ê°€ë©° ì‚¬ìš©.  
- \(\gamma\) : í•´ë‹¹ SNPì˜ íš¨ê³¼ í¬ê¸°(ê·€ë¬´ê°€ì„¤ \(H_0:\gamma=0\)).  
- \(\varepsilon\) : ì”ì°¨(ì•„ì§ ì„¤ëª…ë˜ì§€ ì•Šì€ ë³€ë™).

### ğŸ’¡ í•œëˆˆì— ë³´ê¸°
- **Null model**: SNP íš¨ê³¼ ì—†ì´ ê³µë³€ëŸ‰/ì¹œì¡±êµ¬ì¡°ë§Œìœ¼ë¡œ **ì˜¤ì°¨êµ¬ì¡°Â·ë¶„ì‚°ì„±ë¶„**ì„ ë¨¼ì € ì¶”ì •  
- **GWAS per-SNP**: ìœ„ Nullì„ **ê³ ì •**í•˜ê³  ê° SNPë¥¼ **Score ê³„ì—´ ê²€ì •(Score, Score.SPA ë“±)**ìœ¼ë¡œ ë¹ ë¥´ê²Œ í‰ê°€

GWASì—ì„œ Null model(ê·€ë¬´ëª¨í˜•)ì„ ë¨¼ì € ì í•©í•˜ëŠ” ê²ƒì€ **ì •í™•í•˜ê³  íš¨ìœ¨ì ì¸ ë¶„ì„**ì„ ìœ„í•œ í•µì‹¬ ì „ëµì´ë‹¤. 

1. **í†µê³„ì  íƒ€ë‹¹ì„±(ì œ1ì¢… ì˜¤ë¥˜ í†µì œ)**  
   - ì§‘ë‹¨ êµ¬ì¡°((population stratification)ë‚˜ ì¹œì¡± ê´€ê³„(cryptic relatedness)ê°€ ìˆìœ¼ë©´, ì´ë¥¼ ë³´ì •í•˜ì§€ ì•Šì„ ë•Œ **genomic inflation(Î»)**ì´ ì»¤ì§€ê³  ê±°ì§“ì–‘ì„±(ì œ1ì¢… ì˜¤ë¥˜)ì´ ëŠ˜ì–´ë‚œë‹¤.  
   - Null modelì€ **GRM, \(K\)** ë“±ìœ¼ë¡œ **ì˜¤ì°¨ êµ¬ì¡°ì™€ ë¶„ì‚°ì„±ë¶„**ì„ ë¨¼ì € ì¶”ì •í•´ ì´ êµë€ì„ ì œê±°/ì™„í™”í•œë‹¤. ê·¸ ê²°ê³¼, ì´í›„ SNP ê²€ì •ì—ì„œ **Î»ê°€ ì•ˆì •**ë˜ê³  **ê±°ì§“ì–‘ì„±**ì´ ì–µì œëœë‹¤.

2. **ê³„ì‚° íš¨ìœ¨ì„±(ì†ë„)**  
   - í˜¼í•©ëª¨í˜•ì˜ ë¶„ì‚°ì„±ë¶„ ì¶”ì •ì€ ê³ ë¹„ìš© ì‘ì—…(í° GRM ì—­í–‰ë ¬ ê³„ì‚° ë“±)ì´ë‹¤.  
   - Nullì—ì„œ **í•œ ë²ˆë§Œ** ë¶„ì‚°ì„±ë¶„ì„ ì¶”ì •Â·ê³ ì •í•´ ë‘ê³ , ì´í›„ ê° SNPëŠ” **Score ê³„ì—´ ê²€ì •**ìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ **ìˆ˜ì‹­ë§Œ~ìˆ˜ë°±ë§Œ SNP**ë„ ë¹ ë¥´ê²Œ í‰ê°€í•  ìˆ˜ ìˆë‹¤(ë§¤ SNPë§ˆë‹¤ í˜¼í•©ëª¨í˜•ì„ ì¬ì í•©í•  í•„ìš” ì—†ìŒ).

3. **ê°€ì •(Infinitesimal ê°€ì •)**  
   - ì´ ë°©ë²•ì€ â€œ**ê°œë³„ SNP í•˜ë‚˜ê°€ ì „ì²´ ìœ ì „ë¶„ì‚° \(\sigma_g^2\)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì€ ë§¤ìš° ì‘ë‹¤**â€ëŠ” ê°€ì •ì— ê¸°ë°˜í•œë‹¤.  
   - ë“œë¬¼ê²Œ íŠ¹ì • SNP íš¨ê³¼ê°€ ë§¤ìš° í¬ë©´(ì˜ˆ: ìœ ì „ë ¥ì˜ í° ë¹„ìœ¨) ì•½ê°„ì˜ ì •í™•ë„ ì†ì‹¤ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‚˜, ì¼ë°˜ì ìœ¼ë¡œ Nullâ†’Score ì ˆì°¨ê°€ ê°€ì¥ í•©ë¦¬ì ì´ë‹¤.

#### ğŸ“ˆ Genomic Inflation, \(\lambda\)

- **ì •ì˜**: GWASì—ì„œ ê´€ì¸¡ëœ ê²€ì • í†µê³„ëŸ‰(ë˜ëŠ” P-ê°’)ë“¤ì´ **ê·€ë¬´ê°€ì„¤ í•˜ì˜ ê¸°ëŒ€ì¹˜ë³´ë‹¤ ì „ë°˜ì ìœ¼ë¡œ ë” ìœ ì˜**í•˜ê²Œ ë‚˜ì˜¤ëŠ” í˜„ìƒ. ì´ëŠ” ëª¨ë¸ì´ ë°ì´í„° ì† **ì§‘ë‹¨ ê³„ì¸µí™”**, **ì ì¬ì  ì¹œì¡± ê´€ê³„** ë“±ì„ ì¶©ë¶„íˆ í†µì œí•˜ì§€ ëª»í–ˆì„ ë•Œ ë‚˜íƒ€ë‚˜ëŠ” **ì²´ê³„ì  í¸í–¥(systematic bias)**ì˜ ì‹ í˜¸ì´ë‹¤. 

**ê²°ë¡ **: Null modelì„ ë¨¼ì € ì í•©í•˜ë©´ **genomic inflationì„ ë°©ì§€**í•˜ê³  **ì œ1ì¢… ì˜¤ë¥˜ë¥¼ í†µì œ**í•˜ë©´ì„œ, ëŒ€ê·œëª¨ SNPë¥¼ **ê³ ì†ìœ¼ë¡œ** ë¶„ì„í•  ìˆ˜ ìˆë‹¤. 

:::

```{r}
# ê²°ê³¼ ìš”ì•½
# genomic inflation êµ¬í•˜ê¸°
chisq  <- qchisq(1 - assoc_single$Score.pval, df = 1)
lambda <- median(chisq, na.rm = TRUE)/stats::qchisq(0.5, 1)
# ìš”ì•½ í‘œë¡œ ì •ë¦¬í•˜ê¸°
summary_single <- tibble::tibble(
  trait = single_trait,
  n_snps = sum(!is.na(assoc_single$Score.pval)),
  lambda = lambda,
  n_sig_BH = sum(assoc_single$p_adj_BH < 0.05, na.rm = TRUE),
  n_sig_bonf = sum(assoc_single$p_adj_bonferroni < 0.05, na.rm = TRUE),
  min_p = min(assoc_single$Score.pval, na.rm = TRUE),
  min_p_SNP = assoc_single$variant.id[which.min(assoc_single$Score.pval)],
  min_BH = min(assoc_single$p_adj_BH, na.rm = TRUE)
)
readr::write_csv(summary_single, file.path(tables_dir, paste0("gwas_summary_", single_trait, ".csv")))
```
<div class="alert alert-success" role="alert">
<h4 class="alert-heading">ğŸ“ GWAS ìš”ì•½ ê²°ê³¼</h4>
```{r gwas-summary-table, echo=FALSE}
# 1. ê° ì»¬ëŸ¼ì— ëŒ€í•œ ì£¼ì„(ì„¤ëª…)ì„ ì •ì˜í•©ë‹ˆë‹¤.
column_notes <- c(
  "ë¶„ì„ ëŒ€ìƒ í˜•ì§ˆ ì´ë¦„",
  "ë¶„ì„ì— ì‚¬ìš©ëœ ì´ SNP ê°œìˆ˜",
  "Genomic Inflation Factor (Î»): ì§‘ë‹¨ êµ¬ì¡°í™”ê°€ ì˜ ë³´ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì§€í‘œ. 1ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ì¢‹ìŒ.",
  "BH ë³´ì • ê¸°ì¤€(FDR < 0.05)ì„ ë§Œì¡±í•˜ëŠ” ìœ ì˜ SNP ê°œìˆ˜",
  "Bonferroni ë³´ì • ê¸°ì¤€ì„ ë§Œì¡±í•˜ëŠ” ìœ ì˜ SNP ê°œìˆ˜",
  "ê°€ì¥ ë‚®ì€ P-ê°’ (min P-value)",
  "ê°€ì¥ ë‚®ì€ P-ê°’ì„ ë³´ì´ëŠ” SNPì˜ index ID",
  "ê°€ì¥ ë‚®ì€ BH ë³´ì • P-ê°’ (min FDR)"
)

# 2. ì›ë³¸ ë°ì´í„°ì˜ ì»¬ëŸ¼ ì´ë¦„ì— ì£¼ì„ ê¸°í˜¸ë¥¼ ë¶™ì…ë‹ˆë‹¤.
# (ê¸°ì¡´ summary_single ê°ì²´ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , ì¶œë ¥ìš©ìœ¼ë¡œë§Œ ì»¬ëŸ¼ëª…ì„ ë°”ê¿‰ë‹ˆë‹¤)
summary_for_print <- summary_single
colnames(summary_for_print) <- paste0(colnames(summary_single), " ^", letters[1:ncol(summary_single)], "^")

# 3. kable ì½”ë“œì— escape=FALSE ì™€ footnote() í•¨ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
knitr::kable(
  summary_for_print, 
  digits = 3, 
  escape = FALSE  # escape=FALSEê°€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤!
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  kableExtra::footnote(
    alphabet = column_notes,
    footnote_as_chunk = TRUE,
    title_format = "bold"
  )
```
</div>
```{css, echo=FALSE}
/* R ì½”ë“œ ì²­í¬(echo=TRUE)ì˜ ìŠ¤íƒ€ì¼ì„ ì§€ì •í•©ë‹ˆë‹¤ */
pre.sourceCode {
  background-color: #e7f3ff !important; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
  border: 1px solid #cce0ff !important;   /* ë°°ê²½ìƒ‰ê³¼ ì–´ìš¸ë¦¬ëŠ” ì—°í•œ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
  border-radius: 5px;                      /* ëª¨ì„œë¦¬ë¥¼ ì‚´ì§ ë‘¥ê¸€ê²Œ (ì„ íƒ ì‚¬í•­) */
}

/* í…Œì´ë¸” í—¤ë”(th)ì˜ í…ìŠ¤íŠ¸ê°€ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
.table th {
  white-space: nowrap;
}
```

## GWAS ê²°ê³¼ ì‹œê°í™”
```{r}
# PVE ë¶„í¬ í™•ì¸
p = ggplot(assoc_single, aes(x = PVE*100)) + # PVEë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "grey70", color = "white") +
  geom_density(linewidth = 1) +
  labs(title = "Distribution of Variance Explained (PVE) by Single Variants", x = "PVE (%)", y = "Density") +
  theme_minimal()

print(p)
# í”Œë¡¯ ì €ì¥
ggsave(file.path(figs_dir, paste0("pve_hist_", single_trait, ".png")), p, dpi=300, width=6, height=4)

# ---- QQ í”Œë¡¯ & ë§¨í•´íŠ¼ í”Œë¡¯ -------------------------------
manplot <- assoc_single |>
  dplyr::select(SNP = variant.id, Chromosome = chr, Position = pos, P = Score.pval)

# ì—¼ìƒ‰ì²´ ë¶„ë¥˜ í™•ì¸
dplyr::distinct(manplot, Chromosome)

# U ì—¼ìƒ‰ì²´ ì½”ë”© ë³€ê²½
manplot <- dplyr::mutate(manplot, Chromosome = dplyr::case_when(Chromosome == "U" ~ "X", TRUE ~ Chromosome))

## QQ plot
CMplot::CMplot(                                                           #
  Pmap = manplot,
  plot.type = "q",
  conf.int = TRUE,
  box = TRUE,
  main = paste0("QQ Plot (Î» = ", round(lambda, 3), ")"),
  file = "png",
  dpi = 300, width = 4, height = 4,
  # â†“â†“â†“ í¬ê¸° ì¡°ì ˆ
  axis.cex = 0.7,   # ì¶• ëˆˆê¸ˆ ê¸€ì í¬ê¸°(ê¸°ë³¸ 1 â†’ ë” ì‘ê²Œ)
  lab.cex  = 0.9,   # ì¶• ë¼ë²¨(ì œëª©) í¬ê¸°(ê¸°ë³¸ 1.5 â†’ ë” ì‘ê²Œ)
  main.cex = 1.0,   # íƒ€ì´í‹€ í¬ê¸°(ê¸°ë³¸ 1.5 â†’ ë” ì‘ê²Œ)
 # ë¼ë²¨ ìœ„ì¹˜ ë¯¸ì„¸ì¡°ì •
  xticks.pos = 0.5,    # xì¶• ëˆˆê¸ˆê³¼ ì¶• ê°„ê²©
  ylab.pos   = 1.5,    # yì¶• ë¼ë²¨ê³¼ ì¶• ê°„ê²©
 mar = c(3, 4, 2.5, 2)  # ì•„ë˜-ì™¼-ìœ„-ì˜¤ë¥¸ ì—¬ë°±(í´ë¦½ ë°©ì§€/ë°€ì°© ì¡°ì ˆ)
)
```

<p><em>QQ plot</em></p>
```{r, echo=FALSE}
knitr::include_graphics(file.path(figs_dir, "QQplot.P.png"))
```

```{r}
## Manhattan plot
CMplot::CMplot(
  manplot,
  plot.type = "m",
  LOG10 = TRUE,
  chr.den.col = NULL,
  file = "png",
  dpi = 300, width = 12, height = 4
)
```

<p><em>Manhattan plot</em></p>
```{r, echo=FALSE}
knitr::include_graphics(file.path(figs_dir,"Rect_Manhtn.P.png"))
```

```{r}
## Circular Manhattan plot
CMplot::CMplot(
  manplot,
  plot.type = "c",
  LOG10 = TRUE,
  chr.den.col = NULL,
  file = "png",
  dpi = 300, width = 4, height = 4,
  axis.cex = 0.7,   # ì¶• ëˆˆê¸ˆ ê¸€ì í¬ê¸°(ê¸°ë³¸ 1 â†’ ë” ì‘ê²Œ)
  lab.cex  = 0.9,   # ì¶• ë¼ë²¨(ì œëª©) í¬ê¸°(ê¸°ë³¸ 1.5 â†’ ë” ì‘ê²Œ)
  mar = c(1, 1, 1, 1),   # ê¸°ë³¸(3,6,3,3)ë³´ë‹¤ í›¨ì”¬ íƒ€ì´íŠ¸
  cir.chr.h = 0.6              # ë°”ê¹¥ í¬ë¡œëª¨ì†œ í…Œë‘ë¦¬ ë‘ê»˜ ì¶•ì†Œ
)
```

<p><em>Circular Manhattan plot</em></p>
```{r, echo=FALSE}
knitr::include_graphics(file.path(figs_dir,"Cir_Manhtn.P.png"))
```

```{r, results='hide'}
# plot ìœ„ì¹˜ ë° ì´ë¦„ ë³€ê²½
file.rename("QQplot.P.png", file.path(figs_dir, paste0("QQplot.P_", single_trait, ".png")))
file.rename("Rect_Manhtn.P.png", file.path(figs_dir, paste0("Rect_Manhtn.P_", single_trait, ".png")))
file.rename("Cir_Manhtn.P.png", file.path(figs_dir, paste0("Cir_Manhtn.P_", single_trait, ".png")))
```

```{r, echo=FALSE}
# ---- farm ì„ì˜íš¨ê³¼ í–‰ë ¬(K_farm) êµ¬ì„± -------------------------------------

# 1. PH ë°ì´í„°ì…‹ì˜ farm_id ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ incidence matrix 'Z' ìƒì„±
#    Z í–‰ë ¬: (ê°œì²´ ìˆ˜ n) x (ë†ì¥ ìˆ˜ L) í¬ê¸°
#    ê° í–‰(ê°œì²´)ì€ í•´ë‹¹ ê°œì²´ê°€ ì†í•œ ë†ì¥ ì—´ì—ë§Œ 1ì˜ ê°’ì„ ê°–ê³  ë‚˜ë¨¸ì§€ëŠ” 0ì„ ê°–ëŠ”ë‹¤. 
Z <- model.matrix(~ 0 + farm_id, data = PH)

# 2. Z í–‰ë ¬ì˜ í–‰ ì´ë¦„ì„ ê°œì²´ ID(scanID)ë¡œ ì„¤ì •
rownames(Z) <- PH$scanID

# 3. tcrossprod(Z) í•¨ìˆ˜ (Z %*% t(Z)ì™€ ë™ì¼)ë¥¼ ì´ìš©í•´ n x n í¬ê¸°ì˜ ê³µë¶„ì‚° í–‰ë ¬ K_farmì„ ìƒì„±
#    ì´ í–‰ë ¬ì€ ê°™ì€ ë†ì¥ ì¶œì‹  ê°œì²´ ìŒì€ 1, ë‹¤ë¥¸ ë†ì¥ì´ë©´ 0ì˜ ê°’ì„ ê°–ëŠ”ë‹¤.
K_farm <- tcrossprod(Z)

# 4. í–‰ë ¬ ê³„ì‚° ì‹œ ìˆ˜ì¹˜ì  ì•ˆì •ì„±ì„ ìœ„í•´ ëŒ€ê°ì„ ì— ì•„ì£¼ ì‘ì€ ê°’(ridge)ì„ ë”í•´ì¤€ë‹¤.
K_farm <- K_farm + diag(1e-4, nrow(K_farm))

# 5. ìµœì¢… í–‰ë ¬ì˜ í–‰/ì—´ ì´ë¦„ì„ ê°œì²´ IDë¡œ ì§€ì •
dimnames(K_farm) <- list(PH$scanID, PH$scanID)

```
<style>
  /* ì´ ì¶œë ¥ ë¸”ë¡ ì „ì²´ì˜ ê¸°ë³¸ í°íŠ¸/ì¤„ë†’ì´ í†µì¼ */
  .outputs { font-size: .95rem; line-height: 1.5; }

  /* í‘œì™€ í‘œ ë‚´ë¶€ ìš”ì†Œë“¤ì´ ë™ì¼í•œ í¬ê¸°ë¥¼ ìƒì†ë°›ë„ë¡ ê°•ì œ */
  .outputs .outputs-table,
  .outputs .outputs-table td,
  .outputs .outputs-table th,
  .outputs .outputs-table ul,
  .outputs .outputs-table li,
  .outputs .outputs-table code {
    font-size: inherit !important;
    line-height: inherit !important;
  }

  /* í‘œ ì•ˆ ë¦¬ìŠ¤íŠ¸ ì—¬ë°± ì •ë¦¬ */
  .outputs .outputs-table td ul { margin: 0; padding-left: 1rem; }

  /* í‘œ í­ ìë™ */
  .outputs .outputs-table { table-layout: auto !important; width: 100%; }

  /* ì ˆëŒ€ ì¤„ë°”ê¿ˆ ê¸ˆì§€(ì…€ + ë‚´ë¶€ ëª¨ë“  ìš”ì†Œ) */
  .outputs .outputs-table td.nowrap,
  .outputs .outputs-table td.nowrap *,
  .outputs .outputs-table td.nowrap code {
    white-space: nowrap !important;
    word-break: normal !important;
    overflow-wrap: normal !important;
    hyphens: none !important;
  }

  /* Bootstrap ì—†ëŠ” í™˜ê²½ ëŒ€ë¹„ (ì•ˆì „ì¥ì¹˜) */
  .mb-0 { margin-bottom: 0 !important; }
  .list-unstyled { list-style: none; padding-left: 0; }
</style>

<div class="alert alert-success outputs" role="alert">
  <h4 class="alert-heading">ğŸ“ ìµœì¢…ì¶œë ¥ë¬¼</h4>

  <h5 class="mt-2">í’ˆì¢…ë³„ (<code>05_gwas/&lt;breed&gt;/</code> ë‚´ë¶€)</h5>
  <table class="table table-striped table-condensed outputs-table">
    <thead>
      <tr>
        <th>ìœ„ì¹˜</th>
        <th>íŒŒì¼ ì´ë¦„</th>
        <th>í˜•ì‹</th>
        <th>ì„¤ëª…</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>05_gwas/&lt;breed&gt;/</code></td>
        <td><code>A_matrix_heatmap.png</code></td>
        <td>PNG</td>
        <td>GRM(ìœ ì „ì²´ ê´€ê³„ í–‰ë ¬) íˆíŠ¸ë§µ</td>
      </tr>

      <!-- í”Œë¡¯ í–‰: í”Œë¡¯ë³„ 1ì¤„ì”© í‘œì‹œ -->
      <tr>
        <td><code>05_gwas/&lt;breed&gt;/figs/</code></td>
        <td>
          <ul class="list-unstyled mb-0">
            <li><code>pheno_distribution_&lt;trait&gt;.png</code></li>
            <li><code>pve_hist_&lt;trait&gt;.png</code></li>
            <li><code>QQplot.P_&lt;trait&gt;.png</code></li>
            <li><code>Rect_Manhtn.P_&lt;trait&gt;.png</code></li>
            <li><code>Cir_Manhtn.P_&lt;trait&gt;.png</code></li>
          </ul>
        </td>
        <td>PNG</td>
        <td>
          <ul class="list-unstyled mb-0">
            <li>í‘œí˜„í˜• ë¶„í¬ í”Œë¡¯</li>
            <li>PVE ë¶„í¬ í”Œë¡¯</li>
            <li>QQ í”Œë¡¯(Î» í¬í•¨)</li>
            <li>ë§¨í•´íŠ¼ í”Œë¡¯(ì§ì‚¬ê°í˜•)</li>
            <li>ë§¨í•´íŠ¼ í”Œë¡¯(ì›í˜•)</li>
          </ul>
        </td>
      </tr>

      <!-- GENESIS ì„¤ëª…: í•œ ì¤„ ê³ ì • -->
      <tr>
        <td><code>05_gwas/&lt;breed&gt;/gwas/</code></td>
        <td><code>assoc_&lt;trait&gt;.rds</code></td>
        <td>RDS</td>
        <td class="nowrap">GENESIS::assocTestSingle() ê²°ê³¼&nbsp;ê°ì²´&nbsp;(ì¬ë¶„ì„/ì¶”ê°€&nbsp;ê°€ê³µìš©)
        </td>
      </tr>

      <tr>
        <td><code>05_gwas/&lt;breed&gt;/tables/</code></td>
        <td><code>assoc_&lt;trait&gt;.csv</code></td>
        <td>CSV</td>
        <td>ë‹¨ì¼ ë§ˆì»¤ ì—°ê´€ì„± í‘œ: P-value, íš¨ê³¼, í‘œì¤€ì˜¤ì°¨, PVE, FDR(BH), Bonferroni ë“±</td>
      </tr>

      <tr>
        <td><code>05_gwas/&lt;breed&gt;/tables/</code></td>
        <td><code>gwas_summary_&lt;trait&gt;.csv</code></td>
        <td>CSV</td>
        <td>ìš”ì•½ ì§€í‘œ: SNP ìˆ˜, Î», ìœ ì˜ SNP ê°œìˆ˜(FDR/Bonferroni), ìµœì†Œ P, í•´ë‹¹ SNP index ID</td>
      </tr>
    </tbody>
  </table>

<h5 class="mt-3">ì°¸ê³ </h5>
<ul class="list-unstyled mb-0">
  <li>ğŸ”§ í˜„ì¬ ì„¤ì •
    <ul class="list-unstyled mb-0" style="margin-left:1.1rem">
      <li><code>&lt;breed&gt; = holstein</code></li>
      <li><code>&lt;trait&gt; = days_in_milk</code></li>
    </ul>
  </li>
</ul>
</div>
<style>
  /* 'outputs' ìƒì ë‚´ë¶€ì˜ h5ì™€, ê·¸ ë‹¤ìŒì— ì˜¤ëŠ” ul ë° liì˜ í°íŠ¸ë¥¼ ì¡°ì ˆ */
  .outputs h5 {
    font-size: 1.2em !important; /* ì´ ê°’ì„ ì¡°ì ˆí•˜ì—¬ 'ì°¸ê³ ' ê¸€ì”¨ í¬ê¸° ë³€ê²½ */
    font-weight: 700; /* ê¸€ì”¨ë¥¼ ì¢€ ë” êµµê²Œ (ì„ íƒ ì‚¬í•­) */
  }
  
  .outputs h5 + ul,
  .outputs h5 + ul li {
    font-size: 1.2em !important; 
    line-height: inherit !important;
  }
</style>

## ğŸ‰ Rë¡œ GWAS ê³¼ì • ì™„ë£Œ

<div class="alert alert-success" role="alert" style="margin-top:.5rem">
  <h4 class="alert-heading" style="margin-top:0;margin-bottom:.5rem">âœ… Rë¡œ í•˜ëŠ” GWAS ì ˆì°¨ë¥¼ ëê¹Œì§€ ì˜ ë§ˆì³¤ë‹¤!</h4>
  <p style="margin-bottom:.75rem">
    ëª¨ë“  ë‹¨ê³„ë¥¼ ê±°ì³ ìµœì¢… ì¶œë ¥ë¬¼ì„ ë§Œë“¤ì—ˆë‹¤. ğŸ€
  </p>
  <hr style="margin:.75rem 0" />
  <p class="mb-0">ì´ì œ Holsteinì˜ ë‹¤ë¥¸ í˜•ì§ˆë“¤ê³¼ Jersey ë°ì´í„°ì…‹ì— ëŒ€í•´ì„œë„ GWAS ë¶„ì„ì„ í•  ìˆ˜ ìˆë‹¤. ğŸš€ğŸ”¥</p>
</div>

## ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ë³´ê¸° {#script-full}

<span></span>

<div class="alert alert-secondary" role="alert" style="margin-top:1rem">
  <p><span style="font-size:1.1em">ğŸ“˜ <strong> GWAS R script</strong></span></p>

  <details>
    <summary style="cursor:pointer;font-size:1.15em; font-weight:600">
      <code>gwas_workflow.R</code> íŒŒì¼ â€” ğŸ‘† í´ë¦­í•˜ì—¬ ë³´ê¸°
    </summary>
    <pre><code class="language-r">## 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜ & ë¡œë”©
# ---- ì„¤ì¹˜ì–´ì‹œìŠ¤í„´íŠ¸ -------------------------------------------------------
cran_pkgs <- c("genio", "qqman", "sommer", "lme4breeding", "dplyr", "CMplot", "stringr", "ggplot2", "tibble", "readr")
bioc_pkgs <- c("GENESIS","GWASTools","BiocParallel")

if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")

install_if_missing <- function(pkgs, installer) {
  need <- pkgs[!vapply(pkgs, requireNamespace, logical(1), quietly = TRUE)]
  if (length(need)) installer(need, ask = FALSE)
}

install_if_missing(cran_pkgs, install.packages)
install_if_missing(bioc_pkgs, BiocManager::install)

# ---- ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ------------------------------------------------------
library(genio)
library(GENESIS)
library(GWASTools)
library(qqman)
library(CMplot)
library(lme4breeding)
library(sommer)
library(dplyr)
library(stringr)
library(ggplot2)
library(tibble)

## 2. ê²½ë¡œ/ì…ë ¥ ì •ì˜
breed        <- "holstein"
plink_prefix <- "03_qc/NIAS_ibv3_296ea.holstein"
pheno_file   <- "NIAS_ibv3_296ea_pheno.csv"

report_dir <- file.path("05_gwas", breed)
figs_dir   <- file.path(report_dir, "figs")
gwas_dir   <- file.path(report_dir, "gwas")
tables_dir <- file.path(report_dir, "tables")
for (d in c(report_dir, figs_dir, gwas_dir, tables_dir)) dir.create(d, recursive = TRUE, showWarnings = FALSE)

## 3. PLINK binary ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# read_plink()ëŠ” SNP x Sample í–‰ë ¬(X), bim(ë§ˆì»¤ì •ë³´), fam(ê°œì²´ì •ë³´)ì„ ë¶ˆëŸ¬ì˜¨ë‹¤.
plink <- read_plink(plink_prefix)

X <- plink$X             # í–‰: SNP, ì—´: ìƒ˜í”Œ, ê°’: 0/1/2
bim <- plink$bim         # chr, id, pos, alt, ref ë“±
fam <- plink$fam         # family/sample id ë“±

# ë¯¸ë¦¬ë³´ê¸°
X[1:5, 1:5]
head(bim)
head(fam)

## 4. í‘œí˜„í˜• ë°ì´í„° ë¡œë”© & ì •ë ¬
pheno <- readr::read_csv(pheno_file, show_col_types = FALSE)

sample_id_chr <- colnames(X)  # PLINK ì—´ì´ ìƒ˜í”Œ ID
scanID <- seq_along(sample_id_chr)

pheno_ord <- pheno[match(sample_id_chr, pheno$individual_id), , drop = FALSE]
stopifnot(!any(is.na(pheno_ord$individual_id)))
pheno_ord$sample_id <- sample_id_chr
pheno_ord$scanID    <- scanID
stopifnot(identical(as.character(pheno_ord$individual_id), pheno_ord$sample_id))
# ë¯¸ë¦¬ë³´ê¸°
str(pheno_ord)

# í‘œí˜„í˜• ë¶„í¬ í™•ì¸
# --- ë¶„ì„í•  í˜•ì§ˆì„ ì´ ë³€ìˆ˜ì— ì§€ì • ---
single_trait <- "days_in_milk"

p=ggplot(pheno_ord, aes(x = .data[[single_trait]])) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "grey70", color = "white") +
  geom_density(linewidth = 1) +
  labs(
    title = paste("Distribution of", single_trait),
    x = single_trait, 
    y = "Density"
  ) +
  theme_minimal()

# ë³€ìˆ˜ì— ì €ì¥ëœ í”Œë¡¯ í™•ì¸
print(p)
# ggsave() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ í”Œë¡¯ì„ png íŒŒì¼ë¡œ ì €ì¥
ggsave(
  filename = file.path(figs_dir, paste0("pheno_distribution_", single_trait, ".png")),
  plot = p,
  width = 6,
  height = 4,
  dpi = 300
)

## 5. GRM(ìœ ì „ì²´ ê´€ê³„ í–‰ë ¬) ê³„ì‚° & ê°„ë‹¨ ì‹œê°í™”
# A.matì€ -1/0/1 ì½”ë”©ëœ genotype matrix ì´ìš©
G_mat <- t(X)              # ìƒ˜í”Œ x SNP
colnames(G_mat) <- rownames(X)
rownames(G_mat) <- sample_id_chr

G_code <- G_mat - 1        # 0/1/2 -> -1/0/1
KI     <- sommer::A.mat(G_code)
# ìˆ˜ì¹˜ì•ˆì •ì„±(ì•„ì£¼ ì‘ì€ ridge)
diag(KI) <- diag(KI) + 1e-4

# scanID ê¸°ì¤€ì˜ dimnames ì§€ì •
rownames(KI) <- as.character(scanID)
colnames(KI) <- as.character(scanID)

stopifnot(
  identical(rownames(KI), as.character(scanID)),
  identical(colnames(KI), as.character(scanID))
)

# ìƒìœ„ 5x5 í™•ì¸
KI[1:5, 1:5]

# íˆíŠ¸ë§µ
colfunc <- grDevices::colorRampPalette(c("steelblue4","springgreen","yellow"))

png(file.path(report_dir, "A_matrix_heatmap.png"), width=2000, height=1400, res=200)
stats::heatmap(KI, col = colfunc(100), Colv = "Rowv", symmetric = TRUE)
dev.off()

## 6. GWAS ë¶„ì„ìš© ë°ì´í„° ê°ì²´ ë§Œë“¤ê¸°
bim <- cbind(index = seq_len(nrow(bim)), bim)
stopifnot(all.equal(rownames(X), bim$id))
stopifnot(all.equal(colnames(X), pheno_ord$sample_id))

rownames(X) <- bim$index
colnames(X) <- scanID

# GENESIS íŒ¨í‚¤ì§€ì—ì„œ ìš”êµ¬í•˜ëŠ” ë°ì´í„° ê°ì²´ ë§Œë“¤ê¸°
mg <- GWASTools::MatrixGenotypeReader(
  genotype   = X,
  snpID      = bim$index,
  chromosome = as.integer(bim$chr),
  position   = as.integer(bim$pos),
  scanID     = scanID,
  autosomeCode = 1L:29L,
  XchromCode   = 30L, YchromCode = 31L, XYchromCode = 32L, MchromCode = 33L
)
# ìœ ì „ìí˜• ë°ì´í„° ê°ì²´ ìƒì„±
genoData <- GWASTools::GenotypeData(mg)
# í‘œí˜„í˜• ë°ì´í„° ê°ì²´ ìƒì„±
scanAnno <- GWASTools::ScanAnnotationDataFrame(pheno_ord)
# ê°ì²´ êµ¬ì¡° í™•ì¸
str(genoData)
str(scanAnno@data)   

## 7. GWAS ê·€ë¬´ëª¨í˜• ì í•© ë° ìœ ì „ë ¥(SNP heritability) ê³„ì‚°
# --- ë¶„ì„í•  í˜•ì§ˆì„ ì´ ë³€ìˆ˜ì— ì§€ì • ---
single_trait <- "days_in_milk"

# ë¶„ì„í•  í˜•ì§ˆì´ ë°ì´í„°ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸. ì—†ìœ¼ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê³  ì¤‘ë‹¨
stopifnot(single_trait %in% colnames(scanAnno@data))

# --- ë°ì´í„° ì „ì²˜ë¦¬ ---

# 1. ëª¨ë¸ì—ì„œ íš¨ê³¼ë¥¼ ë¶„ì„í•  ë³€ìˆ˜ë“¤ì„ factor(ë²”ì£¼í˜• ë³€ìˆ˜)ë¡œ ë³€í™˜
pheno_ord$farm_id <- as.factor(pheno_ord$farm_id)
pheno_ord$scanID <- as.factor(pheno_ord$scanID)

# 2. ë¶„ì„í•  í˜•ì§ˆ(days_in_milk)ì— ê²°ì¸¡ì¹˜(NA)ê°€ ìˆëŠ” ìƒ˜í”Œì„ ì œê±°í•˜ì—¬
#    ìµœì¢… ë¶„ì„ ë°ì´í„°ì…‹ 'PH'ë¥¼ ìƒì„±
#    droplevels() í•¨ìˆ˜ëŠ” PH ë°ì´í„°ì…‹ì— ë” ì´ìƒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìƒ˜í”Œì´ë‚˜ ë†ì¥ì˜ ë ˆë²¨ ì •ë³´ë¥¼ ì œê±°
PH <- droplevels(subset(pheno_ord, !is.na(days_in_milk)))

# 3. Kinship í–‰ë ¬(KI)ì„ ìµœì¢… ë¶„ì„ ë°ì´í„°ì…‹ 'PH'ì— ë§ì¶° ìë¥¸ë‹¤.
#    ë°˜ë“œì‹œ 'PH'ì˜ ìƒ˜í”Œ ëª©ë¡ê³¼ ìˆœì„œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ë¼ì•¼,
#    í‘œí˜„í˜• ë°ì´í„°ì™€ Kinship ë°ì´í„°ì˜ ìƒ˜í”Œì´ 1:1ë¡œ ì •í™•í•˜ê²Œ ì¼ì¹˜í•œë‹¤.
K_scan <- KI[levels(PH$scanID), levels(PH$scanID)]

# ë†ì¥ íš¨ê³¼ì™€ ê°œì²´ë³„ ìœ ì „ íš¨ê³¼ë¥¼ ì„ì˜ íš¨ê³¼(random effect)ë¡œ ì„¤ì •í•˜ì—¬ ëª¨ë¸ì„ ë§Œë“ ë‹¤.
# lmebreed í•¨ìˆ˜ëŠ” í˜ˆì—°ê´€ê³„(kinship)ë¥¼ ê³ ë ¤í•œ í˜¼í•© ëª¨ë¸ì„ ì í•©í•´ì¤€ë‹¤.
mix <- lme4breeding::lmebreed(
  # ëª¨ë¸ ê³µì‹: days_in_milkë¥¼ ê°œì²´ íš¨ê³¼(scanID)ì™€ ë†ì¥ íš¨ê³¼(farm_id)ë¡œ ì„¤ëª…
  days_in_milk ~ (1|scanID) + (1|farm_id),
  
  # relmat ì¸ì: scanIDì˜ ì„ì˜ íš¨ê³¼ëŠ” K_scan í–‰ë ¬ì— ì •ì˜ëœ ìœ ì „ì  ê´€ê³„ë¥¼ ë”°ë¥´ë„ë¡ ì§€ì •í•œë‹¤.
  relmat  = list(scanID = K_scan),
  
  # verbose=TRUE: ëª¨ë¸ ê³„ì‚° ê³¼ì •ì„ í™”ë©´ì— ì¶œë ¥
  verbose = TRUE,
  
  # data ì¸ì: ëª¨ë¸ì— ì‚¬ìš©í•  ë°ì´í„°ì…‹ìœ¼ë¡œ PHë¥¼ ì§€ì •
  data    = PH
)

# ëª¨ë¸ ë¶„ì„ ê²°ê³¼ ìš”ì•½ë³¸ ì¶œë ¥
summary(mix)

### í•¨ìˆ˜ë¥¼ ì´ìš©í•œ ìœ ì „ë ¥ ê³„ì‚°
# VarCorr() í•¨ìˆ˜ë¡œ ëª¨ë¸('mix')ì—ì„œ ë¶„ì‚° ì„±ë¶„(Variance Components)ì„ ì¶”ì¶œ
vc <- VarCorr(mix)
print(vc, comp = c("Variance"))

# ì”ì°¨ ë¶„ì‚°(Residual variance)ì„ ì¶”ì¶œ
# VarCorr ê²°ê³¼ì˜ ì†ì„±(attribute) "sc"ëŠ” ì”ì°¨ì˜ í‘œì¤€í¸ì°¨ì´ë¯€ë¡œ ì œê³±í•˜ì—¬ ë¶„ì‚°ì„ êµ¬í•œë‹¤. 
ve <- attr(VarCorr(mix), "sc")^2

# SNP ìœ ì „ë ¥(h2) ê³„ì‚°
# h2 = ìœ ì „ë¶„ì‚° / (ìœ ì „ë¶„ì‚° + ë†ì¥ë¶„ì‚° + ì”ì°¨ë¶„ì‚°)
h2 <- vc$scanID / (vc$scanID +  vc$farm_id + ve)
print(paste("SNP Heritability (h2):", base::as.numeric(h2)))

# ì „ì²´ í‘œí˜„í˜• ë¶„ì‚° ì¤‘ ë†ì¥ íš¨ê³¼(farm ID)ê°€ ì°¨ì§€í•˜ëŠ” ë¶„ì‚° ë¹„ìœ¨ ê³„ì‚°
farm_var <- vc$farm_id / (vc$scanID + vc$farm_id + ve)
print(paste("Farm Variance ratio:", base::as.numeric(farm_var)))

## 8. GWAS ìµœì¢… null ëª¨í˜• ì í•© ë° GWAS
# --- ë¶„ì„í•  í˜•ì§ˆì„ ì´ ë³€ìˆ˜ì— ì§€ì • ---
single_trait <- "days_in_milk"

# ë¶„ì„í•  í˜•ì§ˆì´ ë°ì´í„°ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸. ì—†ìœ¼ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ê³  ì¤‘ë‹¨
stopifnot(single_trait %in% colnames(scanAnno@data))

# ê·€ë¬´ëª¨í˜•
null_single <- GENESIS::fitNullModel(
  x        = scanAnno,
  outcome  = single_trait,
  cov.mat  = list(gen = KI),
  family   = "gaussian"
)

# ëª¨í˜•ì—ì„œ ì¶”ì •ëœ ë¶„ì‚° ì„±ë¶„(ìœ ì „ë¶„ì‚°, ì”ì°¨ë¶„ì‚°)ì„ í™•ì¸
null_single$varComp 
# SNP heritability ê³„ì‚° (h2, CI value)
GENESIS::varCompCI(null_single, prop = TRUE)       

# GWAS ì‹¤í–‰
# ìœ ì „ì²´ ë°ì´í„°ë¥¼ **ë¸”ë¡ ë‹¨ìœ„(ì—¬ê¸°ì„œëŠ” 10,000 SNPì”©)**ë¡œ ìˆœì°¨ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ ì´í„°ë ˆì´í„° ìƒì„±: ë©”ëª¨ë¦¬ ì‚¬ìš©ì„ ì¤„ì´ê¸° ìœ„í•¨
genoIt <- GWASTools::GenotypeBlockIterator(genoData, snpBlock = 10000)
# ìœ„ì—ì„œ ì í•©í•œ ê·€ë¬´ëª¨í˜•ì„ ê³ ì •í•œ ìƒíƒœì—ì„œ, ê° SNPì— ëŒ€í•´ ë‹¨ì¼ë³€ëŸ‰ Score testë¡œ ì—°ê´€ì„±ì„ ê³„ì‚°
assoc_single <- GENESIS::assocTestSingle(
  genoIt, null.model = null_single, BPPARAM = BiocParallel::SerialParam()
)

# ---- P-ê°’ ë³´ì • & ìœ ì˜ SNP ì„ ë³„ ---------------------------------
assoc_single$p_adj_BH=p.adjust(assoc_single$Score.pval, method="BH")
assoc_single$p_adj_bonferroni=p.adjust(assoc_single$Score.pval, method="bonferroni")

# ì €ì¥
saveRDS(assoc_single, file = file.path(gwas_dir, paste0("assoc_", single_trait, ".rds")))
readr::write_csv(assoc_single, file.path(tables_dir, paste0("assoc_", single_trait, ".csv")))

head(assoc_single, 5)

# ê²°ê³¼ ìš”ì•½
# genomic inflation êµ¬í•˜ê¸°
chisq  <- stats::qchisq(1 - assoc_single$Score.pval, df = 1)
lambda <- median(chisq, na.rm = TRUE)/stats::qchisq(0.5, 1)
# ìš”ì•½ í‘œë¡œ ì •ë¦¬í•˜ê¸°
summary_single <- tibble::tibble(
  trait = single_trait,
  n_snps = sum(!is.na(assoc_single$Score.pval)),
  lambda = lambda,
  n_sig_BH = sum(assoc_single$p_adj_BH < 0.05, na.rm = TRUE),
  n_sig_bonf = sum(assoc_single$p_adj_bonferroni < 0.05, na.rm = TRUE),
  min_p = min(assoc_single$Score.pval, na.rm = TRUE),
  min_p_SNP = assoc_single$variant.id[which.min(assoc_single$Score.pval)],
  min_BH = min(assoc_single$p_adj_BH, na.rm = TRUE)
)
readr::write_csv(summary_single, file.path(tables_dir, paste0("gwas_summary_", single_trait, ".csv")))

## 9. GWAS ê²°ê³¼ ì‹œê°í™”
# PVE ë¶„í¬ í™•ì¸
p=ggplot(assoc_single, aes(x = PVE*100)) + # PVEë¥¼ í¼ì„¼íŠ¸ë¡œ ë³€í™˜
  geom_histogram(aes(y = after_stat(density)), bins = 30, fill = "grey70", color = "white") +
  geom_density(linewidth = 1) +
  labs(title = "Distribution of Variance Explained (PVE) by Single Variants", x = "PVE (%)", y = "Density") +
  theme_minimal()

# í”Œë¡¯ ì €ì¥
ggsave(file.path(figs_dir, paste0("pve_hist_", single_trait, ".png")), p, dpi=300, width=6, height=4)

# ---- QQ í”Œë¡¯ & ë§¨í•´íŠ¼ í”Œë¡¯ -------------------------------
manplot <- assoc_single |>
  dplyr::select(SNP = variant.id, Chromosome = chr, Position = pos, P = Score.pval)

# ì—¼ìƒ‰ì²´ ë¶„ë¥˜ í™•ì¸
dplyr::distinct(manplot, Chromosome)

# U ì—¼ìƒ‰ì²´ ì½”ë”© ë³€ê²½
manplot <- dplyr::mutate(manplot, Chromosome = dplyr::case_when(Chromosome == "U" ~ "X", TRUE ~ Chromosome))

## QQ plot
CMplot::CMplot(                                                           #
  Pmap = manplot,
  plot.type = "q",
  conf.int = TRUE,
  box = TRUE,
  main = paste0("QQ Plot (Î» = ", round(lambda, 3), ")"),
  file = "png",
  dpi = 300, width = 4, height = 4,
  # â†“â†“â†“ í¬ê¸° ì¡°ì ˆ
  axis.cex = 0.7,   # ì¶• ëˆˆê¸ˆ ê¸€ì í¬ê¸°(ê¸°ë³¸ 1 â†’ ë” ì‘ê²Œ)
  lab.cex  = 0.9,   # ì¶• ë¼ë²¨(ì œëª©) í¬ê¸°(ê¸°ë³¸ 1.5 â†’ ë” ì‘ê²Œ)
  main.cex = 1.0,   # íƒ€ì´í‹€ í¬ê¸°(ê¸°ë³¸ 1.5 â†’ ë” ì‘ê²Œ)
  # ë¼ë²¨ ìœ„ì¹˜ ë¯¸ì„¸ì¡°ì •
  xticks.pos = 0.5,    # xì¶• ëˆˆê¸ˆê³¼ ì¶• ê°„ê²©
  ylab.pos   = 1.5,    # yì¶• ë¼ë²¨ê³¼ ì¶• ê°„ê²©
  mar = c(3, 4, 2.5, 2)  # ì•„ë˜-ì™¼-ìœ„-ì˜¤ë¥¸ ì—¬ë°±(í´ë¦½ ë°©ì§€/ë°€ì°© ì¡°ì ˆ)
)

## Manhattan plot
CMplot::CMplot(
  manplot,
  plot.type = "m",
  LOG10 = TRUE,
  chr.den.col = NULL,
  file = "png",
  dpi = 300, width = 12, height = 4
)

## Circular Manhattan plot
CMplot::CMplot(
  manplot,
  plot.type = "c",
  LOG10 = TRUE,
  chr.den.col = NULL,
  file = "png",
  dpi = 300, width = 4, height = 4,
  axis.cex = 0.7,   # ì¶• ëˆˆê¸ˆ ê¸€ì í¬ê¸°(ê¸°ë³¸ 1 â†’ ë” ì‘ê²Œ)
  lab.cex  = 0.9,   # ì¶• ë¼ë²¨(ì œëª©) í¬ê¸°(ê¸°ë³¸ 1.5 â†’ ë” ì‘ê²Œ)
  mar = c(1, 1, 1, 1),   # ê¸°ë³¸(3,6,3,3)ë³´ë‹¤ í›¨ì”¬ íƒ€ì´íŠ¸
  cir.chr.h = 0.6              # ë°”ê¹¥ í¬ë¡œëª¨ì†œ í…Œë‘ë¦¬ ë‘ê»˜ ì¶•ì†Œ
)

# plot ìœ„ì¹˜ ë° ì´ë¦„ ë³€ê²½
file.rename("QQplot.P.png", file.path(figs_dir, paste0("QQplot.P_", single_trait, ".png")))
file.rename("Rect_Manhtn.P.png", file.path(figs_dir, paste0("Rect_Manhtn.P_", single_trait, ".png")))
file.rename("Cir_Manhtn.P.png", file.path(figs_dir, paste0("Cir_Manhtn.P_", single_trait, ".png")))
    </code></pre>

  </details>
</div>
